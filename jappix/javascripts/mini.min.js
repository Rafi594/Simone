function XmlHttp(){}function XmlDocument(){}function hex_sha1(e){return binb2hex(core_sha1(str2binb(e),e.length*chrsz))}function b64_sha1(e){return binb2b64(core_sha1(str2binb(e),e.length*chrsz))}function str_sha1(e){return binb2str(core_sha1(str2binb(e),e.length*chrsz))}function hex_hmac_sha1(e,t){return binb2hex(core_hmac_sha1(e,t))}function b64_hmac_sha1(e,t){return binb2b64(core_hmac_sha1(e,t))}function str_hmac_sha1(e,t){return binb2str(core_hmac_sha1(e,t))}function sha1_vm_test(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==hex_sha1("abc")}function core_sha1(e,t){e[t>>5]|=128<<24-t%32,e[(t+64>>9<<4)+15]=t;var i,n,r,a,o,s,c,p,l=new Array(80),u=1732584193,h=-271733879,m=-1732584194,d=271733878,_=-1009589776;for(i=0;i<e.length;i+=16){for(a=u,o=h,s=m,c=d,p=_,n=0;80>n;n++)16>n?l[n]=e[i+n]:l[n]=rol(l[n-3]^l[n-8]^l[n-14]^l[n-16],1),r=safe_add(safe_add(rol(u,5),sha1_ft(n,h,m,d)),safe_add(safe_add(_,l[n]),sha1_kt(n))),_=d,d=m,m=rol(h,30),h=u,u=r;u=safe_add(u,a),h=safe_add(h,o),m=safe_add(m,s),d=safe_add(d,c),_=safe_add(_,p)}return[u,h,m,d,_]}function sha1_ft(e,t,i,n){return 20>e?t&i|~t&n:40>e?t^i^n:60>e?t&i|t&n|i&n:t^i^n}function sha1_kt(e){return 20>e?1518500249:40>e?1859775393:60>e?-1894007588:-899497514}function core_hmac_sha1(e,t){var i=str2binb(e);i.length>16&&(i=core_sha1(i,e.length*chrsz));for(var n=new Array(16),r=new Array(16),a=0;16>a;a++)n[a]=909522486^i[a],r[a]=1549556828^i[a];var o=core_sha1(n.concat(str2binb(t)),512+t.length*chrsz);return core_sha1(r.concat(o),672)}function safe_add(e,t){var i=(65535&e)+(65535&t),n=(e>>16)+(t>>16)+(i>>16);return n<<16|65535&i}function rol(e,t){return e<<t|e>>>32-t}function str2binb(e){for(var t=[],i=(1<<chrsz)-1,n=0;n<e.length*chrsz;n+=chrsz)t[n>>5]|=(e.charCodeAt(n/chrsz)&i)<<32-chrsz-n%32;return t}function binb2str(e){for(var t="",i=(1<<chrsz)-1,n=0;n<32*e.length;n+=chrsz)t+=String.fromCharCode(e[n>>5]>>>32-chrsz-n%32&i);return t}function binb2hex(e){for(var t=hexcase?"0123456789ABCDEF":"0123456789abcdef",i="",n=0;n<4*e.length;n++)i+=t.charAt(e[n>>2]>>8*(3-n%4)+4&15)+t.charAt(e[n>>2]>>8*(3-n%4)&15);return i}function binb2b64(e){for(var t,i,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r="",a=0;a<4*e.length;a+=3)for(t=(e[a>>2]>>8*(3-a%4)&255)<<16|(e[a+1>>2]>>8*(3-(a+1)%4)&255)<<8|e[a+2>>2]>>8*(3-(a+2)%4)&255,i=0;4>i;i++)r+=8*a+6*i>32*e.length?b64pad:n.charAt(t>>6*(3-i)&63);return r}function hex_md5(e){return rstr2hex(rstr_md5(str2rstr_utf8(e)))}function b64_md5(e){return rstr2b64(rstr_md5(str2rstr_utf8(e)))}function any_md5(e,t){return rstr2any(rstr_md5(str2rstr_utf8(e)),t)}function hex_hmac_md5(e,t){return rstr2hex(rstr_hmac_md5(str2rstr_utf8(e),str2rstr_utf8(t)))}function b64_hmac_md5(e,t){return rstr2b64(rstr_hmac_md5(str2rstr_utf8(e),str2rstr_utf8(t)))}function any_hmac_md5(e,t,i){return rstr2any(rstr_hmac_md5(str2rstr_utf8(e),str2rstr_utf8(t)),i)}function md5_vm_test(){return"900150983cd24fb0d6963f7d28e17f72"==hex_md5("abc").toLowerCase()}function rstr_md5(e){return binl2rstr(binl_md5(rstr2binl(e),8*e.length))}function rstr_hmac_md5(e,t){var i=rstr2binl(e);i.length>16&&(i=binl_md5(i,8*e.length));for(var n=Array(16),r=Array(16),a=0;16>a;a++)n[a]=909522486^i[a],r[a]=1549556828^i[a];var o=binl_md5(n.concat(rstr2binl(t)),512+8*t.length);return binl2rstr(binl_md5(r.concat(o),640))}function rstr2hex(e){try{}catch(t){hexcase=0}for(var i,n=hexcase?"0123456789ABCDEF":"0123456789abcdef",r="",a=0;a<e.length;a++)i=e.charCodeAt(a),r+=n.charAt(i>>>4&15)+n.charAt(15&i);return r}function rstr2b64(e){try{}catch(t){b64pad=""}for(var i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n="",r=e.length,a=0;r>a;a+=3)for(var o=e.charCodeAt(a)<<16|(r>a+1?e.charCodeAt(a+1)<<8:0)|(r>a+2?e.charCodeAt(a+2):0),s=0;4>s;s++)n+=8*a+6*s>8*e.length?b64pad:i.charAt(o>>>6*(3-s)&63);return n}function rstr2any(e,t){var i,n,r,a,o,s=t.length,c=Array(Math.ceil(e.length/2));for(i=0;i<c.length;i++)c[i]=e.charCodeAt(2*i)<<8|e.charCodeAt(2*i+1);var p=Math.ceil(8*e.length/(Math.log(t.length)/Math.log(2))),l=Array(p);for(n=0;p>n;n++){for(o=Array(),a=0,i=0;i<c.length;i++)a=(a<<16)+c[i],r=Math.floor(a/s),a-=r*s,(o.length>0||r>0)&&(o[o.length]=r);l[n]=a,c=o}var u="";for(i=l.length-1;i>=0;i--)u+=t.charAt(l[i]);return u}function str2rstr_utf8(e){for(var t,i,n="",r=-1;++r<e.length;)t=e.charCodeAt(r),i=r+1<e.length?e.charCodeAt(r+1):0,t>=55296&&56319>=t&&i>=56320&&57343>=i&&(t=65536+((1023&t)<<10)+(1023&i),r++),127>=t?n+=String.fromCharCode(t):2047>=t?n+=String.fromCharCode(192|t>>>6&31,128|63&t):65535>=t?n+=String.fromCharCode(224|t>>>12&15,128|t>>>6&63,128|63&t):2097151>=t&&(n+=String.fromCharCode(240|t>>>18&7,128|t>>>12&63,128|t>>>6&63,128|63&t));return n}function str2rstr_utf16le(e){for(var t="",i=0;i<e.length;i++)t+=String.fromCharCode(255&e.charCodeAt(i),e.charCodeAt(i)>>>8&255);return t}function str2rstr_utf16be(e){for(var t="",i=0;i<e.length;i++)t+=String.fromCharCode(e.charCodeAt(i)>>>8&255,255&e.charCodeAt(i));return t}function rstr2binl(e){for(var t=Array(e.length>>2),i=0;i<t.length;i++)t[i]=0;for(var i=0;i<8*e.length;i+=8)t[i>>5]|=(255&e.charCodeAt(i/8))<<i%32;return t}function binl2rstr(e){for(var t="",i=0;i<32*e.length;i+=8)t+=String.fromCharCode(e[i>>5]>>>i%32&255);return t}function binl_md5(e,t){e[t>>5]|=128<<t%32,e[(t+64>>>9<<4)+14]=t;for(var i=1732584193,n=-271733879,r=-1732584194,a=271733878,o=0;o<e.length;o+=16){var s=i,c=n,p=r,l=a;i=md5_ff(i,n,r,a,e[o+0],7,-680876936),a=md5_ff(a,i,n,r,e[o+1],12,-389564586),r=md5_ff(r,a,i,n,e[o+2],17,606105819),n=md5_ff(n,r,a,i,e[o+3],22,-1044525330),i=md5_ff(i,n,r,a,e[o+4],7,-176418897),a=md5_ff(a,i,n,r,e[o+5],12,1200080426),r=md5_ff(r,a,i,n,e[o+6],17,-1473231341),n=md5_ff(n,r,a,i,e[o+7],22,-45705983),i=md5_ff(i,n,r,a,e[o+8],7,1770035416),a=md5_ff(a,i,n,r,e[o+9],12,-1958414417),r=md5_ff(r,a,i,n,e[o+10],17,-42063),n=md5_ff(n,r,a,i,e[o+11],22,-1990404162),i=md5_ff(i,n,r,a,e[o+12],7,1804603682),a=md5_ff(a,i,n,r,e[o+13],12,-40341101),r=md5_ff(r,a,i,n,e[o+14],17,-1502002290),n=md5_ff(n,r,a,i,e[o+15],22,1236535329),i=md5_gg(i,n,r,a,e[o+1],5,-165796510),a=md5_gg(a,i,n,r,e[o+6],9,-1069501632),r=md5_gg(r,a,i,n,e[o+11],14,643717713),n=md5_gg(n,r,a,i,e[o+0],20,-373897302),i=md5_gg(i,n,r,a,e[o+5],5,-701558691),a=md5_gg(a,i,n,r,e[o+10],9,38016083),r=md5_gg(r,a,i,n,e[o+15],14,-660478335),n=md5_gg(n,r,a,i,e[o+4],20,-405537848),i=md5_gg(i,n,r,a,e[o+9],5,568446438),a=md5_gg(a,i,n,r,e[o+14],9,-1019803690),r=md5_gg(r,a,i,n,e[o+3],14,-187363961),n=md5_gg(n,r,a,i,e[o+8],20,1163531501),i=md5_gg(i,n,r,a,e[o+13],5,-1444681467),a=md5_gg(a,i,n,r,e[o+2],9,-51403784),r=md5_gg(r,a,i,n,e[o+7],14,1735328473),n=md5_gg(n,r,a,i,e[o+12],20,-1926607734),i=md5_hh(i,n,r,a,e[o+5],4,-378558),a=md5_hh(a,i,n,r,e[o+8],11,-2022574463),r=md5_hh(r,a,i,n,e[o+11],16,1839030562),n=md5_hh(n,r,a,i,e[o+14],23,-35309556),i=md5_hh(i,n,r,a,e[o+1],4,-1530992060),a=md5_hh(a,i,n,r,e[o+4],11,1272893353),r=md5_hh(r,a,i,n,e[o+7],16,-155497632),n=md5_hh(n,r,a,i,e[o+10],23,-1094730640),i=md5_hh(i,n,r,a,e[o+13],4,681279174),a=md5_hh(a,i,n,r,e[o+0],11,-358537222),r=md5_hh(r,a,i,n,e[o+3],16,-722521979),n=md5_hh(n,r,a,i,e[o+6],23,76029189),i=md5_hh(i,n,r,a,e[o+9],4,-640364487),a=md5_hh(a,i,n,r,e[o+12],11,-421815835),r=md5_hh(r,a,i,n,e[o+15],16,530742520),n=md5_hh(n,r,a,i,e[o+2],23,-995338651),i=md5_ii(i,n,r,a,e[o+0],6,-198630844),a=md5_ii(a,i,n,r,e[o+7],10,1126891415),r=md5_ii(r,a,i,n,e[o+14],15,-1416354905),n=md5_ii(n,r,a,i,e[o+5],21,-57434055),i=md5_ii(i,n,r,a,e[o+12],6,1700485571),a=md5_ii(a,i,n,r,e[o+3],10,-1894986606),r=md5_ii(r,a,i,n,e[o+10],15,-1051523),n=md5_ii(n,r,a,i,e[o+1],21,-2054922799),i=md5_ii(i,n,r,a,e[o+8],6,1873313359),a=md5_ii(a,i,n,r,e[o+15],10,-30611744),r=md5_ii(r,a,i,n,e[o+6],15,-1560198380),n=md5_ii(n,r,a,i,e[o+13],21,1309151649),i=md5_ii(i,n,r,a,e[o+4],6,-145523070),a=md5_ii(a,i,n,r,e[o+11],10,-1120210379),r=md5_ii(r,a,i,n,e[o+2],15,718787259),n=md5_ii(n,r,a,i,e[o+9],21,-343485551),i=safe_add(i,s),n=safe_add(n,c),r=safe_add(r,p),a=safe_add(a,l)}return Array(i,n,r,a)}function md5_cmn(e,t,i,n,r,a){return safe_add(bit_rol(safe_add(safe_add(t,e),safe_add(n,a)),r),i)}function md5_ff(e,t,i,n,r,a,o){return md5_cmn(t&i|~t&n,e,t,r,a,o)}function md5_gg(e,t,i,n,r,a,o){return md5_cmn(t&n|i&~n,e,t,r,a,o)}function md5_hh(e,t,i,n,r,a,o){return md5_cmn(t^i^n,e,t,r,a,o)}function md5_ii(e,t,i,n,r,a,o){return md5_cmn(i^(t|~n),e,t,r,a,o)}function safe_add(e,t){var i=(65535&e)+(65535&t),n=(e>>16)+(t>>16)+(i>>16);return n<<16|65535&i}function bit_rol(e,t){return e<<t|e>>>32-t}function utf8t2d(e){e=e.replace(/\r\n/g,"\n");var t=new Array,i=String.fromCharCode(237);if(i.charCodeAt(0)<0)for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);r>0?t[t.length]=r:(t[t.length]=256+r>>6|192,t[t.length]=256+r&63|128)}else for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);128>r?t[t.length]=r:r>127&&2048>r?(t[t.length]=r>>6|192,t[t.length]=63&r|128):(t[t.length]=r>>12|224,t[t.length]=r>>6&63|128,t[t.length]=63&r|128)}return t}function utf8d2t(e){for(var t=new Array,i=0;i<e.length;)e[i]<128?(t[t.length]=String.fromCharCode(e[i]),i++):e[i]>191&&e[i]<224?(t[t.length]=String.fromCharCode((31&e[i])<<6|63&e[i+1]),i+=2):(t[t.length]=String.fromCharCode((15&e[i])<<12|(63&e[i+1])<<6|63&e[i+2]),i+=3);return t.join("")}function b64arrays(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";b64=new Array,f64=new Array;for(var t=0;t<e.length;t++)b64[t]=e.charAt(t),f64[e.charAt(t)]=t}function b64d2t(e){var t=new Array,i=0,n=e.length;for(n%3==1&&(e[e.length]=0,e[e.length]=0),n%3==2&&(e[e.length]=0);i<e.length;)t[t.length]=b64[e[i]>>2],t[t.length]=b64[(3&e[i])<<4|e[i+1]>>4],t[t.length]=b64[(15&e[i+1])<<2|e[i+2]>>6],t[t.length]=b64[63&e[i+2]],i+=3;n%3==1&&(t[t.length-1]=t[t.length-2]="="),n%3==2&&(t[t.length-1]="=");var r=t.join("");return r}function b64t2d(e){var t=new Array,i=0;for(e=e.replace(/\n|\r/g,""),e=e.replace(/=/g,"");i<e.length;)t[t.length]=f64[e.charAt(i)]<<2|f64[e.charAt(i+1)]>>4,t[t.length]=(15&f64[e.charAt(i+1)])<<4|f64[e.charAt(i+2)]>>2,t[t.length]=(3&f64[e.charAt(i+2)])<<6|f64[e.charAt(i+3)],i+=4;return e.length%4==2&&(t=t.slice(0,t.length-2)),e.length%4==3&&(t=t.slice(0,t.length-1)),t}function cnonce(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i="",n=0;e>n;n++)i+=t.charAt(Math.round(Math.random((new Date).getTime())*(t.length-1)));return i}function JSJaCJSON(){}function JSJaCJID(e){this._node="",this._domain="",this._resource="","string"==typeof e?(-1!=e.indexOf("@")&&(this.setNode(e.substring(0,e.indexOf("@"))),e=e.substring(e.indexOf("@")+1)),-1!=e.indexOf("/")&&(this.setResource(e.substring(e.indexOf("/")+1)),e=e.substring(0,e.indexOf("/"))),this.setDomain(e)):(this.setNode(e.node),this.setDomain(e.domain),this.setResource(e.resource))}function JSJaCJIDInvalidException(e){this.message=e,this.name="JSJaCJIDInvalidException"}function JSJaCPacket(e){this.name=e,"undefined"!=typeof JSJACPACKET_USE_XMLNS&&JSJACPACKET_USE_XMLNS?this.doc=XmlDocument.create(e,"jabber:client"):this.doc=XmlDocument.create(e,"")}function JSJaCPresence(){this.base=JSJaCPacket,this.base("presence")}function JSJaCIQ(){this.base=JSJaCPacket,this.base("iq")}function JSJaCMessage(){this.base=JSJaCPacket,this.base("message")}function JSJaCError(e,t,i){var n=XmlDocument.create("error","jsjac");return n.documentElement.setAttribute("code",e),n.documentElement.setAttribute("type",t),i&&n.documentElement.appendChild(n.createElement(i)).setAttribute("xmlns","urn:ietf:params:xml:ns:xmpp-stanzas"),n.documentElement}function JSJaCKeys(e,t){var i=Math.random();if(this._k=new Array,this._k[0]=i.toString(),t?this.oDbg=t:(this.oDbg={},this.oDbg.log=function(){}),e)for(var n=1;n<JSJAC_NKEYS;n++)this._k[n]=e(this._k[n-1]),t.log(n+": "+this._k[n],4);this._indexAt=JSJAC_NKEYS-1,this.getKey=function(){return this._k[this._indexAt--]},this.lastKey=function(){return 0==this._indexAt},this.size=function(){return this._k.length},this._getSuspendVars=function(){return"_k,_indexAt".split(",")}}function JSJaCConnection(e){e&&e.oDbg&&e.oDbg.log?this.oDbg=e.oDbg:(this.oDbg=new Object,this.oDbg.log=function(){}),e&&e.timerval?this.setPollInterval(e.timerval):this.setPollInterval(JSJAC_TIMERVAL),e&&e.httpbase&&(this._httpbase=e.httpbase),e&&e.allow_plain?this.allow_plain=e.allow_plain:this.allow_plain=JSJAC_ALLOW_PLAIN,e&&e.cookie_prefix?this._cookie_prefix=e.cookie_prefix:this._cookie_prefix="",this._connected=!1,this._events=new Array,this._keys=null,this._ID=0,this._inQ=new Array,this._pQueue=new Array,this._regIDs=new Array,this._req=new Array,this._status="intialized",this._errcnt=0,this._inactivity=JSJAC_INACTIVITY,this._sendRawCallbacks=new Array}function genID(){return STANZA_ID++}function JSJaCHttpBindingConnection(e){this.base=JSJaCConnection,this.base(e),this._hold=JSJACHBC_MAX_HOLD,this._inactivity=0,this._last_requests=new Object,this._last_rid=0,this._min_polling=0,this._pause=0,this._wait=JSJACHBC_MAX_WAIT}function JSJaCWebSocketConnection(e){this.base=JSJaCConnection,this.base(e),this._ws=null,this.registerHandler("onerror",JSJaC.bind(this._cleanupWebSocket,this))}function STANZA_ERROR(e,t,i){return window==this?new STANZA_ERROR(e,t,i):(this.code=e,this.type=t,void(this.cond=i))}var Origin=function(){var e={};return e.isSame=function(e){try{var t=window.location,i=document.createElement("a");return i.href=e,!(i.hostname&&i.hostname!=t.hostname||i.port&&i.port!=t.port||i.protocol&&i.protocol!=t.protocol)}catch(n){Console.error("Origin.isSame",n)}},e}(),JappixOrigin=Origin;!function(e){var t=e.setTimeout,i=e.document,n=0;e.jXHR=function(){function r(){try{h.parentNode.removeChild(h)}catch(e){}}function a(){u=!1,l="",r(),h=null,p(0)}function o(e){try{m.onerror.call(m,e,l)}catch(t){}}function s(){this.readyState&&"complete"!==this.readyState&&"loaded"!==this.readyState||u||(this.onload=this.onreadystatechange=null,u=!0,4!==m.readyState&&o("handleScriptLoad: Script failed to load ["+l+"]."),r())}function c(e){var t=null;if(window.DOMParser){var i=new DOMParser;t=i.parseFromString(e,"text/xml")}else t=new ActiveXObject("Microsoft.XMLDOM"),t.async="false",t.loadXML(e);return t}function p(e,t){t=t||[],m.readyState=e,4==e&&(m.responseText=t[0].reply,m.responseXML=c(t[0].reply)),"function"==typeof m.onreadystatechange&&m.onreadystatechange.apply(m,t)}var l,u,h,m=null;return m={onerror:null,onreadystatechange:null,readyState:0,status:200,responseBody:null,responseText:null,responseXML:null,open:function(t,i){a();var r="cb"+n++;!function(t){e.jXHR[t]=function(){try{p.call(m,4,arguments)}catch(i){m.readyState=-1,o("Script failed to run ["+l+"].")}e.jXHR[t]=null}}(r),l=i+"?callback=?jXHR&data=",l=l.replace(/=\?jXHR/,"=jXHR."+r),p(1)},send:function(e){l+=encodeURIComponent(e),t(function(){h=i.createElement("script"),h.setAttribute("type","text/javascript"),h.onload=h.onreadystatechange=function(){s.call(h)},h.setAttribute("src",l),i.getElementsByTagName("head")[0].appendChild(h)},0),p(2)},abort:function(){},setRequestHeader:function(){},getResponseHeader:function(){return""},getAllResponseHeaders:function(){return[]}},a(),m}}(window);var Base64=function(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t={encode:function(t){var i,n,r,a,o,s,c,p="",l=0;do i=t.charCodeAt(l++),n=t.charCodeAt(l++),r=t.charCodeAt(l++),a=i>>2,o=(3&i)<<4|n>>4,s=(15&n)<<2|r>>6,c=63&r,isNaN(n)?s=c=64:isNaN(r)&&(c=64),p=p+e.charAt(a)+e.charAt(o)+e.charAt(s)+e.charAt(c);while(l<t.length);return p},decode:function(t){var i,n,r,a,o,s,c,p="",l=0;t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");do a=e.indexOf(t.charAt(l++)),o=e.indexOf(t.charAt(l++)),s=e.indexOf(t.charAt(l++)),c=e.indexOf(t.charAt(l++)),i=a<<2|o>>4,n=(15&o)<<4|s>>2,r=(3&s)<<6|c,p+=String.fromCharCode(i),64!=s&&(p+=String.fromCharCode(n)),64!=c&&(p+=String.fromCharCode(r));while(l<t.length);return p}};return t}(),JSJaC={Version:"1.3",bind:function(e,t,i){return function(n){return e.apply(t,[n,i])}}};XmlHttp.create=function(){try{if(!BOSH_SAME_ORIGIN){if(window.XMLHttpRequest){var e=new XMLHttpRequest;if(void 0!==e.withCredentials)return e}return new jXHR}if(window.XMLHttpRequest){var e=new XMLHttpRequest;return null==e.readyState&&(e.readyState=1,e.addEventListener("load",function(){e.readyState=4,"function"==typeof e.onreadystatechange&&e.onreadystatechange()},!1)),e}if(window.ActiveXObject)return new ActiveXObject(XmlHttp.getPrefix()+".XmlHttp")}catch(t){}throw new Error("Your browser does not support XmlHttp objects")},XmlHttp.getPrefix=function(){if(XmlHttp.prefix)return XmlHttp.prefix;for(var e,t=["MSXML2","Microsoft","MSXML","MSXML3"],i=0;i<t.length;i++)try{return e=new ActiveXObject(t[i]+".XmlHttp"),XmlHttp.prefix=t[i]}catch(n){}throw new Error("Could not find an installed XML parser")},XmlDocument.create=function(e,t){e=e||"foo",t=t||"";try{var i;if(document.implementation&&document.implementation.createDocument?(i=document.implementation.createDocument(t,e,null),null==i.readyState&&(i.readyState=1,i.addEventListener("load",function(){i.readyState=4,"function"==typeof i.onreadystatechange&&i.onreadystatechange()},!1))):window.ActiveXObject&&(i=new ActiveXObject(XmlDocument.getPrefix()+".DomDocument")),!i.documentElement||i.documentElement.tagName!=e||i.documentElement.namespaceURI&&i.documentElement.namespaceURI!=t)try{""!=t?i.appendChild(i.createElement(e)).setAttribute("xmlns",t):i.appendChild(i.createElement(e))}catch(n){i=document.implementation.createDocument(t,e,null),null==i.documentElement&&i.appendChild(i.createElement(e)),""!=t&&i.documentElement.getAttribute("xmlns")!=t&&i.documentElement.setAttribute("xmlns",t)}return i}catch(r){}throw new Error("Your browser does not support XmlDocument objects")},XmlDocument.getPrefix=function(){if(XmlDocument.prefix)return XmlDocument.prefix;for(var e,t=["MSXML2","Microsoft","MSXML","MSXML3"],i=0;i<t.length;i++)try{return e=new ActiveXObject(t[i]+".DomDocument"),XmlDocument.prefix=t[i]}catch(n){}throw new Error("Could not find an installed XML parser")},"undefined"!=typeof Document&&window.DOMParser&&(Document.prototype.loadXML=function(e){for(var t=(new DOMParser).parseFromString(e,"text/xml");this.hasChildNodes();)this.removeChild(this.lastChild);for(var i=0;i<t.childNodes.length;i++)this.appendChild(this.importNode(t.childNodes[i],!0))}),window.XMLSerializer&&window.Node&&Node.prototype&&Node.prototype.__defineGetter__&&(XMLDocument.prototype.__defineGetter__("xml",function(){return(new XMLSerializer).serializeToString(this)}),Document.prototype.__defineGetter__("xml",function(){return(new XMLSerializer).serializeToString(this)}),Node.prototype.__defineGetter__("xml",function(){return(new XMLSerializer).serializeToString(this)})),String.prototype.htmlEnc=function(){return this?this.replace(/&(?!(amp|apos|gt|lt|quot);)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\'/g,"&apos;").replace(/\"/g,"&quot;").replace(/\n/g,"<br />"):this},String.prototype.revertHtmlEnc=function(){if(!this)return this;var e=this.replace(/&amp;/gi,"&");return e=e.replace(/&lt;/gi,"<"),e=e.replace(/&gt;/gi,">"),e=e.replace(/&apos;/gi,"'"),e=e.replace(/&quot;/gi,'"'),e=e.replace(/<br( )?(\/)?>/gi,"\n")},Date.jab2date=function(e){if(!isNaN(e))return new Date(1e3*e);var t=new Date(Date.UTC(e.substr(0,4),e.substr(5,2)-1,e.substr(8,2),e.substr(11,2),e.substr(14,2),e.substr(17,2)));if("Z"!=e.substr(e.length-6,1)){var i=60*t.getTimezoneOffset()*1e3,n=new Date;n.setTime(0),n.setUTCHours(e.substr(e.length-5,2)),n.setUTCMinutes(e.substr(e.length-2,2)),"+"==e.substr(e.length-6,1)?t.setTime(t.getTime()+n.getTime()+i):"-"==e.substr(e.length-6,1)&&t.setTime(t.getTime()-n.getTime()+i)}return t},Date.hrTime=function(e){return Date.jab2date(e).toLocaleString()},Date.now||(Date.now=function(){return(new Date).getTime()}),Date.prototype.jabberDate=function(){var e=function(e){return 10>e?"0"+e:e},t=this.getUTCFullYear()+"-";return t+=e(this.getUTCMonth()+1)+"-",t+=e(this.getUTCDate())+"T",t+=e(this.getUTCHours())+":",t+=e(this.getUTCMinutes())+":",t+=e(this.getUTCSeconds())+"Z"},Number.max=function(e,t){return e>t?e:t},Number.min=function(e,t){return t>e?e:t};var hexcase=0,b64pad="=",chrsz=8;("undefined"==typeof atob||"undefined"==typeof btoa)&&b64arrays(),"undefined"==typeof atob?b64decode=function(e){return utf8d2t(b64t2d(e))}:b64decode=function(e){return decodeURIComponent(escape(atob(e)))},"undefined"==typeof btoa?b64encode=function(e){return b64d2t(utf8t2d(e))}:b64encode=function(e){return btoa(unescape(encodeURIComponent(e)))},JSJAC_HAVEKEYS=!0,JSJAC_NKEYS=16,JSJAC_INACTIVITY=300,JSJAC_ERR_COUNT=10,JSJAC_ALLOW_PLAIN=!0,JSJAC_CHECKQUEUEINTERVAL=100,JSJAC_CHECKINQUEUEINTERVAL=100,JSJAC_TIMERVAL=2e3,JSJAC_ALLOW_PLAIN=!0,JSJAC_ALLOW_SCRAM=!1,JSJAC_RETRYDELAY=5e3,JSJAC_REGID_TIMEOUT=2e4,JSJACHBC_MAX_HOLD=1,JSJACHBC_MAX_WAIT=20,JSJACHBC_BOSH_VERSION="1.6",JSJACHBC_USE_BOSH_VER=!0,JSJACHBC_MAXPAUSE=20,JSJaCJSON.toString=function(e){var t={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},i={array:function(e){var t,n,r,a,o=["["],s=e.length;for(r=0;s>r;r+=1)if(a=e[r],n=i[typeof a])try{a=n(a),"string"==typeof a&&(t&&(o[o.length]=","),o[o.length]=a,t=!0)}catch(c){}return o[o.length]="]",o.join("")},"boolean":function(e){return String(e)},"null":function(e){return"null"},number:function(e){return isFinite(e)?String(e):"null"},object:function(e){if(e){if(e instanceof Array)return i.array(e);var t,n,r,a,o=["{"];for(r in e)if(e.hasOwnProperty(r)&&(a=e[r],n=i[typeof a]))try{a=n(a),"string"==typeof a&&(t&&(o[o.length]=","),o.push(i.string(r),":",a),t=!0)}catch(s){}return o[o.length]="}",o.join("")}return"null"},string:function(e){return/["\\\x00-\x1f]/.test(e)&&(e=e.replace(/([\x00-\x1f\\"])/g,function(e,i){var n=t[i];return n?n:(n=i.charCodeAt(),"\\u00"+Math.floor(n/16).toString(16)+(n%16).toString(16))})),'"'+e+'"'}};switch(typeof e){case"object":return i.object(e);case"array":return i.array(e)}},JSJaCJSON.parse=function(str){try{return!/[^,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]/.test(str.replace(/"(\\.|[^"\\])*"/g,""))&&eval("("+str+")")}catch(e){return!1}};var JSJACJID_FORBIDDEN=['"'," ","&","'","/",":","<",">","@"];JSJaCJID.prototype.getNode=function(){return this._node},JSJaCJID.prototype.getDomain=function(){return this._domain},JSJaCJID.prototype.getResource=function(){return this._resource},JSJaCJID.prototype.setNode=function(e){return JSJaCJID._checkNodeName(e),this._node=e||"",this},JSJaCJID.prototype.setDomain=function(e){if(!e||""==e)throw new JSJaCJIDInvalidException("domain name missing");return JSJaCJID._checkNodeName(e),this._domain=e,this},JSJaCJID.prototype.setResource=function(e){return this._resource=e||"",this},JSJaCJID.prototype.toString=function(){var e="";return this.getNode()&&""!=this.getNode()&&(e=this.getNode()+"@"),e+=this.getDomain(),this.getResource()&&""!=this.getResource()&&(e+="/"+this.getResource()),e},JSJaCJID.prototype.removeResource=function(){return this.setResource()},JSJaCJID.prototype.clone=function(){return new JSJaCJID(this.toString())},JSJaCJID.prototype.isEntity=function(e){return"string"==typeof e&&(e=new JSJaCJID(e)),e.removeResource(),this.clone().removeResource().toString()===e.toString()},JSJaCJID._checkNodeName=function(e){if(e&&""!=e)for(var t=0;t<JSJACJID_FORBIDDEN.length;t++)if(-1!=e.indexOf(JSJACJID_FORBIDDEN[t]))throw new JSJaCJIDInvalidException("forbidden char in nodename: "+JSJACJID_FORBIDDEN[t])};var JSJaCBuilder={buildNode:function(e,t){var i,n=arguments[4];if(arguments[2])if(JSJaCBuilder._isStringOrNumber(arguments[2])||arguments[2]instanceof Array)i=this._createElement(e,t,n),JSJaCBuilder._children(e,i,arguments[2]);else{n=arguments[2].xmlns||n,i=this._createElement(e,t,n);for(attr in arguments[2])arguments[2].hasOwnProperty(attr)&&"xmlns"!=attr&&i.setAttribute(attr,arguments[2][attr])}else i=this._createElement(e,t,n);return arguments[3]&&JSJaCBuilder._children(e,i,arguments[3],n),i},_createElement:function(e,t,i){try{if(i)return e.createElementNS(i,t)}catch(n){}var r=e.createElement(t);return i&&r.setAttribute("xmlns",i),r},_text:function(e,t){return e.createTextNode(t)},_children:function(e,t,i,n){if("object"==typeof i){for(var r in i)if(i.hasOwnProperty(r)){var a=i[r];if("object"==typeof a)if(a instanceof Array){var o=JSJaCBuilder.buildNode(e,a[0],a[1],a[2],n);t.appendChild(o)}else t.appendChild(a);else JSJaCBuilder._isStringOrNumber(a)&&t.appendChild(JSJaCBuilder._text(e,a))}}else JSJaCBuilder._isStringOrNumber(i)&&t.appendChild(JSJaCBuilder._text(e,i))},_attributes:function(e){var t=[];for(attribute in e)e.hasOwnProperty(attribute)&&t.push(attribute+'="'+e[attribute].toString().htmlEnc()+'"');return t.join(" ")},_isStringOrNumber:function(e){return"string"==typeof e||"number"==typeof e}},JSJACPACKET_USE_XMLNS=!0;JSJaCPacket.prototype.pType=function(){return this.name},JSJaCPacket.prototype.getDoc=function(){return this.doc},JSJaCPacket.prototype.getNode=function(){return this.getDoc()&&this.getDoc().documentElement?this.getDoc().documentElement:null},JSJaCPacket.prototype.setTo=function(e){return e&&""!=e?"string"==typeof e?this.getNode().setAttribute("to",e):this.getNode().setAttribute("to",e.toString()):this.getNode().removeAttribute("to"),this},JSJaCPacket.prototype.setFrom=function(e){return e&&""!=e?"string"==typeof e?this.getNode().setAttribute("from",e):this.getNode().setAttribute("from",e.toString()):this.getNode().removeAttribute("from"),this},JSJaCPacket.prototype.setID=function(e){return e&&""!=e?this.getNode().setAttribute("id",e):this.getNode().removeAttribute("id"),this},JSJaCPacket.prototype.setType=function(e){return e&&""!=e?this.getNode().setAttribute("type",e):this.getNode().removeAttribute("type"),this},JSJaCPacket.prototype.setXMLLang=function(e){return navigator.appVersion.match(/^.*MSIE (\d)/)||navigator.appVersion.match(/Trident/)?this:(e&&""!=e?this.getNode().setAttribute("xml:lang",e):this.getNode().removeAttribute("xml:lang"),this)},JSJaCPacket.prototype.getTo=function(){return this.getNode().getAttribute("to")},JSJaCPacket.prototype.getFrom=function(){return this.getNode().getAttribute("from")},JSJaCPacket.prototype.getToJID=function(){return new JSJaCJID(this.getTo())},JSJaCPacket.prototype.getFromJID=function(){return new JSJaCJID(this.getFrom())},JSJaCPacket.prototype.getID=function(){return this.getNode().getAttribute("id")},JSJaCPacket.prototype.getType=function(){return this.getNode().getAttribute("type")},JSJaCPacket.prototype.getXMLLang=function(){return this.getNode().getAttribute("xml:lang")},JSJaCPacket.prototype.getXMLNS=function(){return this.getNode().namespaceURI||this.getNode().getAttribute("xmlns")},JSJaCPacket.prototype.getChild=function(e,t){if(!this.getNode())return null;if(e=e||"*",t=t||"*",this.getNode().getElementsByTagNameNS)return this.getNode().getElementsByTagNameNS(t,e).item(0);var i=this.getNode().getElementsByTagName(e);if("*"==t)return i.item(0);for(var n=0;n<i.length;n++)if(i.item(n).namespaceURI==t||i.item(n).getAttribute("xmlns")==t)return i.item(n);return null},JSJaCPacket.prototype.getChildVal=function(e,t){var i=this.getChild(e,t),n="";if(i&&i.hasChildNodes())for(var r=0;r<i.childNodes.length;r++)i.childNodes.item(r).nodeValue&&(n+=i.childNodes.item(r).nodeValue);return n},JSJaCPacket.prototype.clone=function(){return JSJaCPacket.wrapNode(this.getNode())},JSJaCPacket.prototype.isError=function(){return"error"==this.getType()},JSJaCPacket.prototype.errorReply=function(e){var t=this.clone();return t.setTo(this.getFrom()),t.setFrom(),t.setType("error"),t.appendNode("error",{code:e.code,type:e.type},[[e.cond]]),t},JSJaCPacket.prototype.xml="undefined"!=typeof XMLSerializer?function(){var e=(new XMLSerializer).serializeToString(this.getNode());return"undefined"==typeof e&&(e=(new XMLSerializer).serializeToString(this.doc)),e}:function(){return this.getDoc().xml},JSJaCPacket.prototype._getAttribute=function(e){return this.getNode().getAttribute(e)},null==document.ELEMENT_NODE&&(document.ELEMENT_NODE=1,document.ATTRIBUTE_NODE=2,document.TEXT_NODE=3,document.CDATA_SECTION_NODE=4,document.ENTITY_REFERENCE_NODE=5,document.ENTITY_NODE=6,document.PROCESSING_INSTRUCTION_NODE=7,document.COMMENT_NODE=8,document.DOCUMENT_NODE=9,document.DOCUMENT_TYPE_NODE=10,document.DOCUMENT_FRAGMENT_NODE=11,document.NOTATION_NODE=12),JSJaCPacket.prototype._importNode=function(e,t){switch(e.nodeType){case document.ELEMENT_NODE:if(this.getDoc().createElementNS)var i=this.getDoc().createElementNS(e.namespaceURI,e.nodeName);else var i=this.getDoc().createElement(e.nodeName);if(e.attributes&&e.attributes.length>0)for(var n=0,r=e.attributes.length;r>n;n++){var a=e.attributes.item(n);("xmlns"!=a.nodeName||null==i.getAttribute("xmlns"))&&(i.setAttributeNS&&a.namespaceURI?i.setAttributeNS(a.namespaceURI,a.nodeName,a.nodeValue):i.setAttribute(a.nodeName,a.nodeValue))}if(t&&e.childNodes&&e.childNodes.length>0)for(var n=0,r=e.childNodes.length;r>n;n++)i.appendChild(this._importNode(e.childNodes.item(n),t));return i;case document.TEXT_NODE:case document.CDATA_SECTION_NODE:case document.COMMENT_NODE:return this.getDoc().createTextNode(e.nodeValue)}},JSJaCPacket.prototype._setChildNode=function(e,t){var i=this.getChild(e),n=this.getDoc().createTextNode(t);if(i)try{i.replaceChild(n,i.firstChild)}catch(r){}else{try{i=this.getDoc().createElementNS(this.getNode().namespaceURI,e)}catch(a){i=this.getDoc().createElement(e)}this.getNode().appendChild(i),i.appendChild(n)}return i},JSJaCPacket.prototype.buildNode=function(e){return JSJaCBuilder.buildNode(this.getDoc(),e,arguments[1],arguments[2])},JSJaCPacket.prototype.appendNode=function(e){return"object"==typeof e?this.getNode().appendChild(e):this.getNode().appendChild(this.buildNode(e,arguments[1],arguments[2],null,this.getNode().namespaceURI))},JSJaCPresence.prototype=new JSJaCPacket,JSJaCPresence.prototype.setStatus=function(e){return this._setChildNode("status",e),this},JSJaCPresence.prototype.setShow=function(e){return("chat"==e||"away"==e||"xa"==e||"dnd"==e)&&this._setChildNode("show",e),this},JSJaCPresence.prototype.setPriority=function(e){return this._setChildNode("priority",e),this},JSJaCPresence.prototype.setPresence=function(e,t,i){return e&&this.setShow(e),t&&this.setStatus(t),i&&this.setPriority(i),this},JSJaCPresence.prototype.getStatus=function(){return this.getChildVal("status")},JSJaCPresence.prototype.getShow=function(){return this.getChildVal("show")},JSJaCPresence.prototype.getPriority=function(){return this.getChildVal("priority")},JSJaCIQ.prototype=new JSJaCPacket,JSJaCIQ.prototype.setIQ=function(e,t,i){return e&&this.setTo(e),t&&this.setType(t),i&&this.setID(i),this},JSJaCIQ.prototype.setQuery=function(e){var t;try{t=this.getDoc().createElementNS(e,"query")}catch(i){t=this.getDoc().createElement("query"),t.setAttribute("xmlns",e)}return this.getNode().appendChild(t),t},JSJaCIQ.prototype.getQuery=function(){return this.getNode().getElementsByTagName("query").item(0)},JSJaCIQ.prototype.getQueryXMLNS=function(){return this.getQuery()?this.getQuery().namespaceURI||this.getQuery().getAttribute("xmlns"):null},JSJaCIQ.prototype.reply=function(e){var t=this.clone();if(t.setTo(this.getFrom()),t.setFrom(),t.setType("result"),e)if("string"==typeof e)t.getChild().appendChild(t.getDoc().loadXML(e));else if(e.constructor==Array)for(var i=t.getChild(),n=0;n<e.length;n++)"string"==typeof e[n]?i.appendChild(t.getDoc().loadXML(e[n])):"object"==typeof e[n]&&i.appendChild(e[n]);else"object"==typeof e&&t.getChild().appendChild(e);return t},JSJaCMessage.prototype=new JSJaCPacket,JSJaCMessage.prototype.setBody=function(e){return this._setChildNode("body",e),this},JSJaCMessage.prototype.setSubject=function(e){return this._setChildNode("subject",e),this},JSJaCMessage.prototype.setThread=function(e){return this._setChildNode("thread",e),this},JSJaCMessage.prototype.setNick=function(e){var t=this.getChild("nick"),i=this.getDoc().createTextNode(e);if(t)try{t.replaceChild(i,t.firstChild)}catch(n){}else{try{t=this.getDoc().createElementNS("http://jabber.org/protocol/nick","nick")}catch(r){t=this.getDoc().createElement("nick")}this.getNode().appendChild(t),
t.appendChild(i)}return this},JSJaCMessage.prototype.getThread=function(){return this.getChildVal("thread")},JSJaCMessage.prototype.getBody=function(){return this.getChildVal("body")},JSJaCMessage.prototype.getSubject=function(){return this.getChildVal("subject")},JSJaCMessage.prototype.getNick=function(){return this.getChildVal("nick")},JSJaCPacket.wrapNode=function(e){var t=null;switch(e.nodeName.toLowerCase()){case"presence":t=new JSJaCPresence;break;case"message":t=new JSJaCMessage;break;case"iq":t=new JSJaCIQ}return t&&t.getDoc().replaceChild(t._importNode(e,!0),t.getNode()),t};var STANZA_ID=1;JSJaCConnection.prototype.connect=function(e){this._setStatus("connecting"),this.domain=e.domain||"localhost",this.username=e.username,this.resource=e.resource,this.pass=e.pass,this.register=e.register,this.authhost=e.authhost||this.domain,this.authtype=e.authtype||"sasl",e.xmllang&&""!=e.xmllang?this._xmllang=e.xmllang:this._xmllang="en",this.host=e.host||this.domain,this.port=e.port||5222,e.secure?this.secure="true":this.secure="false",e.wait&&(this._wait=e.wait),this.jid=this.username+"@"+this.domain,this.fulljid=this.jid+"/"+this.resource,this._rid=Math.round(100000.5+799999.99999*Math.random());var t=this._getFreeSlot();this._req[t]=this._setupRequest(!0);var i=this._getInitialRequestString();this.oDbg.log(i,4),this._req[t].r.onreadystatechange=JSJaC.bind(function(){var e=this._req[t].r;4==e.readyState&&(this.oDbg.log("async recv: "+e.responseText,4),this._handleInitialResponse(e))},this),"undefined"!=typeof this._req[t].r.onerror&&(this._req[t].r.onerror=JSJaC.bind(function(e){return this.oDbg.log("XmlHttpRequest error",1),!1},this)),this._req[t].r.send(i)},JSJaCConnection.prototype.connected=function(){return this._connected},JSJaCConnection.prototype.disconnect=function(){if(this._setStatus("disconnecting"),this.connected()){this._connected=!1,clearInterval(this._interval),clearInterval(this._inQto),this._timeout&&clearTimeout(this._timeout);var e=this._getFreeSlot();this._req[e]=this._setupRequest(!1),request=this._getRequestString(!1,!0),this.oDbg.log("Disconnecting: "+request,4),this._req[e].r.send(request);try{DataStore.removeDB(MINI_HASH,"jsjac","state")}catch(t){}this.oDbg.log("Disconnected: "+this._req[e].r.responseText,2),this._handleEvent("ondisconnect")}},JSJaCConnection.prototype.getPollInterval=function(){return this._timerval},JSJaCConnection.prototype.registerHandler=function(event){event=event.toLowerCase();var eArg={handler:arguments[arguments.length-1],childName:"*",childNS:"*",type:"*"};arguments.length>2&&(eArg.childName=arguments[1]),arguments.length>3&&(eArg.childNS=arguments[2]),arguments.length>4&&(eArg.type=arguments[3]),this._events[event]?this._events[event]=this._events[event].concat(eArg):this._events[event]=new Array(eArg),this._events[event]=this._events[event].sort(function(a,b){var aRank=0,bRank=0;with(a)"*"==type&&aRank++,"*"==childNS&&aRank++,"*"==childName&&aRank++;with(b)"*"==type&&bRank++,"*"==childNS&&bRank++,"*"==childName&&bRank++;return aRank>bRank?1:bRank>aRank?-1:0}),this.oDbg.log("registered handler for event '"+event+"'",2)},JSJaCConnection.prototype.unregisterHandler=function(e,t){if(e=e.toLowerCase(),this._events[e]){for(var i=this._events[e],n=new Array,r=0;r<i.length;r++)i[r].handler!=t&&n.push(i[r]);i.length!=n.length&&(this._events[e]=n,this.oDbg.log("unregistered handler for event '"+e+"'",2))}},JSJaCConnection.prototype.registerIQGet=function(e,t,i){this.registerHandler("iq",e,t,"get",i)},JSJaCConnection.prototype.registerIQSet=function(e,t,i){this.registerHandler("iq",e,t,"set",i)},JSJaCConnection.prototype.resume=function(){try{var e=DataStore.getDB(MINI_HASH,"jsjac","state");return this.oDbg.log("read cookie: "+e,2),DataStore.removeDB(MINI_HASH,"jsjac","state"),this.resumeFromData(JSJaCJSON.parse(e))}catch(t){}return!1},JSJaCConnection.prototype.resumeFromData=function(e){try{this._setStatus("resuming");for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);if(this._keys){this._keys2=new JSJaCKeys;for(var i=this._keys2._getSuspendVars(),t=0;t<i.length;t++)this._keys2[i[t]]=this._keys[i[t]];this._keys=this._keys2}return this._connected&&(this._handleEvent("onresume"),setTimeout(JSJaC.bind(this._resume,this),this.getPollInterval()),this._interval=setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL),this._inQto=setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL)),this._connected===!0}catch(n){return n.message?this.oDbg.log("Resume failed: "+n.message,1):this.oDbg.log("Resume failed: "+n,1),!1}},JSJaCConnection.prototype.send=function(e,t,i){if(!e||!e.pType)return this.oDbg.log("no packet: "+e,1),!1;if(!this.connected())return!1;e.getID()||e.setID(genID()),e.getXMLLang()||e.setXMLLang(XML_LANG),t&&this._registerPID(e,t,i);try{this._handleEvent(e.pType()+"_out",e),this._handleEvent("packet_out",e),this._pQueue=this._pQueue.concat(e.xml())}catch(n){return this.oDbg.log(n.toString(),1),!1}return!0},JSJaCConnection.prototype.sendIQ=function(e,t,i){if(!e||"iq"!=e.pType())return!1;t=t||{};var n=t.error_handler||JSJaC.bind(function(e){this.oDbg.log(e.xml(),1)},this),r=t.result_handler||JSJaC.bind(function(e){this.oDbg.log(e.xml(),2)},this),a=function(e,t){switch(e.getType()){case"error":n(e);break;case"result":r(e,t)}};return this.send(e,a,i)},JSJaCConnection.prototype.setPollInterval=function(e){return e&&!isNaN(e)&&(this._timerval=e),this._timerval},JSJaCConnection.prototype.status=function(){return this._status},JSJaCConnection.prototype.suspend=function(e){var t=this.suspendToData(e);try{var i=DataStore.setDB(MINI_HASH,"jsjac","state",JSJaCJSON.toString(t));return i}catch(n){this.oDbg.log("Failed creating cookie '"+this._cookie_prefix+"JSJaC_State': "+n.message,1)}return!1},JSJaCConnection.prototype.suspendToData=function(e){e&&(clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),this._suspend());var t="_connected,_keys,_ID,_inQ,_pQueue,_regIDs,_errcnt,_inactivity,domain,username,resource,jid,fulljid,_sid,_httpbase,_timerval,_is_polling".split(",");t=t.concat(this._getSuspendVars());for(var i=new Object,n=0;n<t.length;n++)if(this[t[n]]){if(this[t[n]]._getSuspendVars)for(var r=this[t[n]]._getSuspendVars(),a=new Object,o=0;o<r.length;o++)a[r[o]]=this[t[n]][r[o]];else var a=this[t[n]];i[t[n]]=a}return e&&(this._connected=!1,this._setStatus("suspending")),i},JSJaCConnection.prototype._abort=function(){clearTimeout(this._timeout),clearInterval(this._inQto),clearInterval(this._interval),this._connected=!1,this._setStatus("aborted"),this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),this._handleEvent("onerror",JSJaCError("500","cancel","service-unavailable"))},JSJaCConnection.prototype._checkInQ=function(){for(var e=0;e<this._inQ.length&&10>e;e++){var t=this._inQ[0];this._inQ=this._inQ.slice(1,this._inQ.length);var i=JSJaCPacket.wrapNode(t);if(!i)return;this._handleEvent("packet_in",i),i.pType&&!this._handlePID(i)&&(this._handleEvent(i.pType()+"_in",i),this._handleEvent(i.pType(),i))}},JSJaCConnection.prototype._checkQueue=function(){return 0!=this._pQueue.length&&this._process(),!0},JSJaCConnection.prototype._doAuth=function(){return this.has_sasl&&"nonsasl"==this.authtype&&this.oDbg.log("Warning: SASL present but not used",1),this._doSASLAuth()||this._doLegacyAuth()?!0:(this.oDbg.log("Auth failed for authtype "+this.authtype,1),this.disconnect(),!1)},JSJaCConnection.prototype._doInBandReg=function(){if("saslanon"!=this.authtype&&"anonymous"!=this.authtype){var e=new JSJaCIQ;e.setType("set"),e.setID("reg1"),e.appendNode("query",{xmlns:"jabber:iq:register"},[["username",this.username],["password",this.pass]]),this.send(e,this._doInBandRegDone)}},JSJaCConnection.prototype._doInBandRegDone=function(e){return e&&"error"==e.getType()?(this.oDbg.log("registration failed for "+this.username,0),void this._handleEvent("onerror",e.getChild("error"))):(this.oDbg.log(this.username+" registered succesfully",0),void this._doAuth())},JSJaCConnection.prototype._doLegacyAuth=function(){if("nonsasl"!=this.authtype&&"anonymous"!=this.authtype)return!1;var e=new JSJaCIQ;return e.setIQ(null,"get","auth1"),e.appendNode("query",{xmlns:"jabber:iq:auth"},[["username",this.username]]),this.send(e,this._doLegacyAuth2),!0},JSJaCConnection.prototype._doLegacyAuth2=function(e){if(!e||"result"!=e.getType())return e&&"error"==e.getType()&&this._handleEvent("onerror",e.getChild("error")),void this.disconnect();var t=null!=e.getChild("digest"),e=new JSJaCIQ;if(e.setIQ(null,"set","auth2"),query=e.appendNode("query",{xmlns:"jabber:iq:auth"},[["username",this.username],["resource",this.resource]]),t)query.appendChild(e.buildNode("digest",{xmlns:"jabber:iq:auth"},hex_sha1(this.streamid+this.pass)));else{if(!this.allow_plain)return this.oDbg.log("no valid login mechanism found",1),this.disconnect(),!1;query.appendChild(e.buildNode("password",{xmlns:"jabber:iq:auth"},this.pass))}this.send(e,this._doLegacyAuthDone)},JSJaCConnection.prototype._doLegacyAuthDone=function(e){"result"!=e.getType()?("error"==e.getType()&&this._handleEvent("onerror",e.getChild("error")),this.disconnect()):this._handleEvent("onconnect")},JSJaCConnection.prototype._doSASLAuth=function(){if("nonsasl"==this.authtype||"anonymous"==this.authtype)return!1;if("saslanon"==this.authtype){if(this.mechs.ANONYMOUS)return this.oDbg.log("SASL using mechanism 'ANONYMOUS'",2),this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='ANONYMOUS'/>",this._doSASLAuthDone);this.oDbg.log("SASL ANONYMOUS requested but not supported",1)}else{if(this.mechs["DIGEST-MD5"])return this.oDbg.log("SASL using mechanism 'DIGEST-MD5'",2),this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='DIGEST-MD5'/>",this._doSASLAuthDigestMd5S1);if(this.allow_plain&&this.mechs.PLAIN){this.oDbg.log("SASL using mechanism 'PLAIN'",2);var e=this.username+"@"+this.domain+String.fromCharCode(0)+this.username+String.fromCharCode(0)+this.pass;return this.oDbg.log("authenticating with '"+e+"'",2),e=b64encode(e),this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='PLAIN'>"+e+"</auth>",this._doSASLAuthDone)}this.oDbg.log("No SASL mechanism applied",1),this.authtype="nonsasl"}return!1},JSJaCConnection.prototype._doSASLAuthDigestMd5S1=function(e){if("challenge"!=e.nodeName)this.oDbg.log("challenge missing",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect();else{var t=b64decode(e.firstChild.nodeValue);if(this.oDbg.log("got challenge: "+t,2),this._nonce=t.substring(t.indexOf("nonce=")+7),this._nonce=this._nonce.substring(0,this._nonce.indexOf('"')),this.oDbg.log("nonce: "+this._nonce,2),""==this._nonce||-1!=this._nonce.indexOf('"'))return this.oDbg.log("nonce not valid, aborting",1),void this.disconnect();this._digest_uri="xmpp/",this._digest_uri+=this.domain,this._cnonce=cnonce(14),this._nc="00000001";var i=this.username+":"+this.domain+":"+this.pass,n=rstr_md5(str2rstr_utf8(i)),r=n+":"+this._nonce+":"+this._cnonce,a=rstr2hex(rstr_md5(r)),o="AUTHENTICATE:"+this._digest_uri,s=hex_md5(o),c=hex_md5(a+":"+this._nonce+":"+this._nc+":"+this._cnonce+":auth:"+s),p='username="'+this.username+'",realm="'+this.domain+'",nonce="'+this._nonce+'",cnonce="'+this._cnonce+'",nc="'+this._nc+'",qop=auth,digest-uri="'+this._digest_uri+'",response="'+c+'",charset="utf-8"';this.oDbg.log("response: "+p,2),this._sendRaw("<response xmlns='urn:ietf:params:xml:ns:xmpp-sasl'>"+b64encode(p)+"</response>",this._doSASLAuthDigestMd5S2)}},JSJaCConnection.prototype._doSASLAuthDigestMd5S2=function(e){if("failure"==e.nodeName)return e.xml?this.oDbg.log("auth error: "+e.xml,1):this.oDbg.log("auth error",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),void this.disconnect();var t=b64decode(e.firstChild.nodeValue);this.oDbg.log("response: "+t,2);var i=t.substring(t.indexOf("rspauth=")+8);this.oDbg.log("rspauth: "+i,2);var n=this.username+":"+this.domain+":"+this.pass,r=rstr_md5(str2rstr_utf8(n)),a=r+":"+this._nonce+":"+this._cnonce,o=rstr2hex(rstr_md5(a)),s=":"+this._digest_uri,c=hex_md5(s),p=hex_md5(o+":"+this._nonce+":"+this._nc+":"+this._cnonce+":auth:"+c);return this.oDbg.log("rsptest: "+p,2),p!=i?(this.oDbg.log("SASL Digest-MD5: server repsonse with wrong rspauth",1),void this.disconnect()):void("success"==e.nodeName?this._reInitStream(JSJaC.bind(this._doStreamBind,this)):this._sendRaw("<response xmlns='urn:ietf:params:xml:ns:xmpp-sasl'/>",this._doSASLAuthDone))},JSJaCConnection.prototype._doSASLAuthDone=function(e){"success"!=e.nodeName?(this.oDbg.log("auth failed",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect()):this._reInitStream(JSJaC.bind(this._doStreamBind,this))},JSJaCConnection.prototype._doStreamBind=function(){var e=new JSJaCIQ;e.setIQ(null,"set","bind_1"),e.appendNode("bind",{xmlns:"urn:ietf:params:xml:ns:xmpp-bind"},[["resource",this.resource]]),this.oDbg.log(e.xml()),this.send(e,this._doXMPPSess)},JSJaCConnection.prototype._doXMPPSess=function(e){return"result"!=e.getType()||"error"==e.getType()?(this.disconnect(),void("error"==e.getType()&&this._handleEvent("onerror",e.getChild("error")))):(this.fulljid=e.getChildVal("jid"),this.jid=this.fulljid.substring(0,this.fulljid.lastIndexOf("/")),this.legacy_sessions?(e=new JSJaCIQ,e.setIQ(null,"set","sess_1"),e.appendNode("session",{xmlns:"urn:ietf:params:xml:ns:xmpp-session"},[]),this.oDbg.log(e.xml()),void this.send(e,this._doXMPPSessDone)):void this._handleEvent("onconnect"))},JSJaCConnection.prototype._doXMPPSessDone=function(e){return"result"!=e.getType()||"error"==e.getType()?(this.disconnect(),void("error"==e.getType()&&this._handleEvent("onerror",e.getChild("error")))):void this._handleEvent("onconnect")},JSJaCConnection.prototype._handleEvent=function(e,t){if(e=e.toLowerCase(),this.oDbg.log("incoming event '"+e+"'",3),this._events[e]){this.oDbg.log("handling event '"+e+"'",2);for(var i=0;i<this._events[e].length;i++){var n=this._events[e][i];if("function"==typeof n.handler)try{if(t){if(t.pType){if(!t.getNode().hasChildNodes()&&"*"!=n.childName||t.getNode().hasChildNodes()&&!t.getChild(n.childName,n.childNS))continue;if("*"!=n.type&&t.getType()!=n.type)continue;this.oDbg.log(n.childName+"/"+n.childNS+"/"+n.type+" => match for handler "+n.handler,3)}if(n.handler(t))break}else if(n.handler())break}catch(r){r.fileName&&r.lineNumber?this.oDbg.log(n.handler+"\n>>>"+r.name+": "+r.message+" in "+r.fileName+" line "+r.lineNumber,1):this.oDbg.log(n.handler+"\n>>>"+r.name+": "+r.message,1)}}}},JSJaCConnection.prototype._handlePID=function(e){if(!e.getID())return!1;var t=e.getFrom()||this.jid;e.getFrom()==this.domain&&(t=this.jid);var i=e.getID();if(this._regIDs[t]&&this._regIDs[t][i])try{this.oDbg.log("handling id "+i,3);var n=this._regIDs[t][i];return n.cb.call(this,e,n.arg)===!1?!1:(delete this._regIDs[t][i],!0)}catch(r){return this.oDbg.log(r.name+": "+r.message,1),delete this._regIDs[t][i],!0}else this.oDbg.log("not handling id '"+i+"' from jid "+t,1);return!1},JSJaCConnection.prototype._handleResponse=function(e){var t=this._parseResponse(e);if(t)for(var i=0;i<t.childNodes.length;i++)if(this._sendRawCallbacks.length){var n=this._sendRawCallbacks[0];this._sendRawCallbacks=this._sendRawCallbacks.slice(1,this._sendRawCallbacks.length),n.fn.call(this,t.childNodes.item(i),n.arg)}else this._inQ=this._inQ.concat(t.childNodes.item(i))},JSJaCConnection.prototype._parseStreamFeatures=function(e){if(!e)return this.oDbg.log("nothing to parse ... aborting",1),!1;var t;if(e.getElementsByTagNameNS)t=e.getElementsByTagNameNS("http://etherx.jabber.org/streams","error").item(0);else for(var i=e.getElementsByTagName("error"),n=0;n<i.length;n++)if("http://etherx.jabber.org/streams"==i.item(n).namespaceURI||"http://etherx.jabber.org/streams"==i.item(n).getAttribute("xmlns")){t=i.item(n);break}if(t)return this._setStatus("internal_server_error"),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),this._handleEvent("onerror",JSJaCError("503","cancel","session-terminate")),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),!1;this.mechs=new Object;var r=e.getElementsByTagName("mechanisms");this.has_sasl=!1;for(var n=0;n<r.length;n++)if("urn:ietf:params:xml:ns:xmpp-sasl"==r.item(n).getAttribute("xmlns")){this.has_sasl=!0;for(var a=r.item(n).getElementsByTagName("mechanism"),o=0;o<a.length;o++)this.mechs[a.item(o).firstChild.nodeValue]=!0;break}if(!this.has_sasl)return this.oDbg.log("No support for SASL detected",2),!1;this.oDbg.log("SASL detected",2),this.server_caps=null;for(var s=e.getElementsByTagName("c"),n=0;n<s.length;n++){var c=s.item(n),p=c.getAttribute("xmlns"),l=c.getAttribute("ver");if(p==NS_CAPS&&l){this.server_caps=l;break}}return this.legacy_sessions=null,e.getElementsByTagName("session")&&(this.legacy_sessions=!0),!0},JSJaCConnection.prototype._process=function(e){if(!this.connected())return this.oDbg.log("Connection lost ...",1),void(this._interval&&clearInterval(this._interval));this.setPollInterval(e),this._timeout&&clearTimeout(this._timeout);var t=this._getFreeSlot();if(!(0>t)){if("undefined"!=typeof this._req[t]&&"undefined"!=typeof this._req[t].r&&4!=this._req[t].r.readyState)return void this.oDbg.log("Slot "+t+" is not ready");if(!this.isPolling()&&0==this._pQueue.length&&this._req[(t+1)%2]&&4!=this._req[(t+1)%2].r.readyState)return void this.oDbg.log("all slots busy, standby ...",2);this.isPolling()||this.oDbg.log("Found working slot at "+t,2),this._req[t]=this._setupRequest(!0),this._req[t].r.onreadystatechange=JSJaC.bind(function(){if(4==this._req[t].r.readyState){if(this._setStatus("processing"),this.oDbg.log("async recv: "+this._req[t].r.responseText,4),this._handleResponse(this._req[t]),!this.connected())return;this._pQueue.length?this._timeout=setTimeout(JSJaC.bind(this._process,this),100):(this.oDbg.log("scheduling next poll in "+this.getPollInterval()+" msec",4),this._timeout=setTimeout(JSJaC.bind(this._process,this),this.getPollInterval()))}},this);try{this._req[t].r.onerror=JSJaC.bind(function(){return this.connected()?(this._errcnt++,this.oDbg.log("XmlHttpRequest error ("+this._errcnt+")",1),this._errcnt>JSJAC_ERR_COUNT?(this._abort(),!1):(this._setStatus("onerror_fallback"),setTimeout(JSJaC.bind(this._resume,this),this.getPollInterval()),!1)):void 0},this)}catch(i){}var n=this._getRequestString();"undefined"!=typeof this._rid&&(this._req[t].rid=this._rid),this.oDbg.log("sending: "+n,4),this._req[t].r.send(n)}},JSJaCConnection.prototype._registerPID=function(e,t,i){this.oDbg.log("registering id for packet "+e.xml(),3);var n=e.getID();if(!n)return this.oDbg.log("id missing",1),!1;if("function"!=typeof t)return this.oDbg.log("callback is not a function",1),!1;var r=e.getTo()||this.jid;return e.getTo()==this.domain&&(r=this.jid),this._regIDs[r]||(this._regIDs[r]={}),null!=this._regIDs[r][n]?(this.oDbg.log("id already registered: "+n,1),!1):(this._regIDs[r][n]={cb:t,arg:i,ts:Date.now()},this.oDbg.log("registered id "+n,3),this._cleanupRegisteredPIDs(),!0)},JSJaCConnection.prototype._cleanupRegisteredPIDs=function(){var e=Date.now();for(var t in this._regIDs)if(this._regIDs.hasOwnProperty(t))for(var i in this._regIDs[t])this._regIDs[t].hasOwnProperty(i)&&this._regIDs[t][i].ts+JSJAC_REGID_TIMEOUT<e&&(this.oDbg.log("deleting registered id '"+i+"' due to timeout",1),delete this._regIDs[t][i])},JSJaCConnection.prototype._prepSendEmpty=function(e,t){return function(){t._sendEmpty(JSJaC.bind(e,t))}},JSJaCConnection.prototype._sendEmpty=function(e){var t=this._getFreeSlot();this._req[t]=this._setupRequest(!0),this._req[t].r.onreadystatechange=JSJaC.bind(function(){4==this._req[t].r.readyState&&(this.oDbg.log("async recv: "+this._req[t].r.responseText,4),e(this._req[t].r))},this),"undefined"!=typeof this._req[t].r.onerror&&(this._req[t].r.onerror=JSJaC.bind(function(e){return this.oDbg.log("XmlHttpRequest error",1),!1},this));var i=this._getRequestString();this.oDbg.log("sending: "+i,4),this._req[t].r.send(i)},JSJaCConnection.prototype._sendRaw=function(e,t,i){return t&&this._sendRawCallbacks.push({fn:t,arg:i}),this._pQueue.push(e),this._process(),!0},JSJaCConnection.prototype._setStatus=function(e){e&&""!=e&&e!=this._status&&(this._status=e,this._handleEvent("onstatuschanged",e),this._handleEvent("status_changed",e))},JSJaCHttpBindingConnection.prototype=new JSJaCConnection,JSJaCHttpBindingConnection.prototype.inherit=function(e){if(e.jid){var t=new JSJaCJID(e.jid);this.domain=t.getDomain(),this.username=t.getNode(),this.resource=t.getResource()}else this.domain=e.domain||"localhost",this.username=e.username,this.resource=e.resource;this._sid=e.sid,this._rid=e.rid,this._min_polling=e.polling,this._inactivity=e.inactivity,this._setHold(e.requests-1),this.setPollInterval(this._timerval),e.wait&&(this._wait=e.wait),this._connected=!0,this._handleEvent("onconnect"),this._interval=setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL),this._inQto=setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL),this._timeout=setTimeout(JSJaC.bind(this._process,this),this.getPollInterval())},JSJaCHttpBindingConnection.prototype.setPollInterval=function(e){return e&&!isNaN(e)&&(this.isPolling()?this._min_polling&&e<1e3*this._min_polling?this._timerval=1e3*this._min_polling:this._inactivity&&e>1e3*this._inactivity?this._timerval=1e3*this._inactivity:this._timerval=e:this._timerval=100),this._timerval},JSJaCHttpBindingConnection.prototype.isPolling=function(){return 0==this._hold},JSJaCHttpBindingConnection.prototype._getFreeSlot=function(){for(var e=0;e<this._hold+1;e++)if("undefined"==typeof this._req[e]||"undefined"==typeof this._req[e].r||4==this._req[e].r.readyState)return e;return-1},JSJaCHttpBindingConnection.prototype._getHold=function(){return this._hold},JSJaCHttpBindingConnection.prototype._getRequestString=function(e,t){e=e||"";var i="";if(this._rid<=this._last_rid&&"undefined"!=typeof this._last_requests[this._rid])i=this._last_requests[this._rid].xml;else{for(var n="";this._pQueue.length;){var r=this._pQueue[0];n+=r,this._pQueue=this._pQueue.slice(1,this._pQueue.length)}i="<body xml:lang='"+XML_LANG+"' rid='"+this._rid+"' sid='"+this._sid+"' xmlns='http://jabber.org/protocol/httpbind' ",JSJAC_HAVEKEYS&&(i+="key='"+this._keys.getKey()+"' ",this._keys.lastKey()&&(this._keys=new JSJaCKeys(hex_sha1,this.oDbg),i+="newkey='"+this._keys.getKey()+"' ")),t?i+="type='terminate'":this._reinit&&(JSJACHBC_USE_BOSH_VER&&(i+="xmpp:restart='true' xmlns:xmpp='urn:xmpp:xbosh' to='"+this.domain+"'"),this._reinit=!1),i+=""!=n||""!=e?">"+e+n+"</body>":"/>",this._last_requests[this._rid]=new Object,this._last_requests[this._rid].xml=i,this._last_rid=this._rid;for(var a in this._last_requests)this._last_requests.hasOwnProperty(a)&&a<this._rid-this._hold&&delete this._last_requests[a]}return i},JSJaCHttpBindingConnection.prototype._getInitialRequestString=function(){var e="<body xml:lang='"+XML_LANG+"' content='text/xml; charset=utf-8' hold='"+this._hold+"' xmlns='http://jabber.org/protocol/httpbind' to='"+this.authhost+"' wait='"+this._wait+"' rid='"+this._rid+"'";return this.secure&&(e+=" secure='"+this.secure+"'"),JSJAC_HAVEKEYS&&(this._keys=new JSJaCKeys(hex_sha1,this.oDbg),key=this._keys.getKey(),e+=" newkey='"+key+"'"),JSJACHBC_USE_BOSH_VER&&(e+=" ver='"+JSJACHBC_BOSH_VERSION+"'",e+=" xmlns:xmpp='urn:xmpp:xbosh'",("sasl"==this.authtype||"saslanon"==this.authtype)&&(e+=" xmpp:version='1.0'")),e+="/>"},JSJaCHttpBindingConnection.prototype._getStreamID=function(e){if(this.oDbg.log(e.responseText,4),!e.responseXML||!e.responseXML.documentElement)return void this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"));var t=e.responseXML.documentElement;return"terminate"==t.getAttribute("type")?void this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")):(t.getAttribute("authid")&&(this.streamid=t.getAttribute("authid"),this.oDbg.log("got streamid: "+this.streamid,2)),this._parseStreamFeatures(t)?(this._timeout=setTimeout(JSJaC.bind(this._process,this),this.getPollInterval()),void(this.register?this._doInBandReg():this._doAuth())):void this._sendEmpty(JSJaC.bind(this._getStreamID,this)))},JSJaCHttpBindingConnection.prototype._getSuspendVars=function(){return"host,port,secure,_rid,_last_rid,_wait,_min_polling,_inactivity,_hold,_last_requests,_pause".split(",")},JSJaCHttpBindingConnection.prototype._handleInitialResponse=function(e){try{this.oDbg.log(e.getAllResponseHeaders(),4),this.oDbg.log(e.responseText,4)}catch(t){this.oDbg.log("No response",4)}if(200!=e.status||!e.responseXML)return this.oDbg.log("initial response broken (status: "+e.status+")",1),void this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"));var i=e.responseXML.documentElement;return i&&"body"==i.tagName&&"http://jabber.org/protocol/httpbind"==i.namespaceURI?"terminate"==i.getAttribute("type")?(this.oDbg.log("invalid response:\n"+e.responseText,1),clearTimeout(this._timeout),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),void this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))):(this._sid=i.getAttribute("sid"),this.oDbg.log("got sid: "+this._sid,2),i.getAttribute("polling")&&(this._min_polling=i.getAttribute("polling")),i.getAttribute("inactivity")&&(this._inactivity=i.getAttribute("inactivity")),i.getAttribute("requests")&&this._setHold(i.getAttribute("requests")-1),this.oDbg.log("set hold to "+this._getHold(),2),i.getAttribute("ver")&&(this._bosh_version=i.getAttribute("ver")),i.getAttribute("maxpause")&&(this._pause=Number.min(i.getAttribute("maxpause"),JSJACHBC_MAXPAUSE)),this.setPollInterval(this._timerval),this._connected=!0,this._inQto=setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL),this._interval=setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL),void this._getStreamID(e)):(this.oDbg.log("no body element or incorrect body in initial response",1),void this._handleEvent("onerror",JSJaCError("500","wait","internal-service-error")))},JSJaCHttpBindingConnection.prototype._parseResponse=function(e){if(!this.connected()||!e)return null;var t=e.r;try{if(404==t.status||403==t.status)return this._abort(),null;if(200!=t.status||!t.responseXML){this._errcnt++;var i="invalid response ("+t.status+"):\n"+t.getAllResponseHeaders()+"\n"+t.responseText;return t.responseXML||(i+="\nResponse failed to parse!"),this.oDbg.log(i,1),this._errcnt>JSJAC_ERR_COUNT?(this._abort(),null):(this.connected()&&(this.oDbg.log("repeating ("+this._errcnt+")",1),this._setStatus("proto_error_fallback"),setTimeout(JSJaC.bind(this._resume,this),this.getPollInterval())),null)}}catch(n){return this.oDbg.log("XMLHttpRequest error: status not available",1),this._errcnt++,this._errcnt>JSJAC_ERR_COUNT?this._abort():this.connected()&&(this.oDbg.log("repeating ("+this._errcnt+")",1),this._setStatus("proto_error_fallback"),setTimeout(JSJaC.bind(this._resume,this),this.getPollInterval())),null}var r=t.responseXML.documentElement;if(!r||"body"!=r.tagName||"http://jabber.org/protocol/httpbind"!=r.namespaceURI)return this.oDbg.log("invalid response:\n"+t.responseText,1),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),this._setStatus("internal_server_error"),this._handleEvent("onerror",JSJaCError("500","wait","internal-server-error")),null;if("undefined"!=typeof e.rid&&this._last_requests[e.rid]){if(this._last_requests[e.rid].handled)return this.oDbg.log("already handled "+e.rid,2),null;this._last_requests[e.rid].handled=!0}if("terminate"==r.getAttribute("type")){var a=r.getAttribute("condition");if("item-not-found"!=a){this.oDbg.log("session terminated:\n"+t.responseText,1),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto);try{DataStore.removeDB(MINI_HASH,"jsjac","state")}catch(n){}this._connected=!1,"remote-stream-error"==a&&r.getElementsByTagName("conflict").length>0&&this._setStatus("session-terminate-conflict"),null==a&&(a="session-terminate"),this._handleEvent("onerror",JSJaCError("503","cancel",a)),this.oDbg.log("Aborting remaining connections",4);for(var o=0;o<this._hold+1;o++)try{this._req[o].r.abort()}catch(n){this.oDbg.log(n,1)}this.oDbg.log("parseResponse done with terminating",3),this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect")}else this._errcnt++,this._errcnt>JSJAC_ERR_COUNT&&this._abort();return null}return this._errcnt=0,t.responseXML.documentElement},JSJaCHttpBindingConnection.prototype._reInitStream=function(e){this._reinit=!0,this._sendEmpty(this._prepReInitStreamWait(e))},JSJaCHttpBindingConnection.prototype._prepReInitStreamWait=function(e){return JSJaC.bind(function(t){this._reInitStreamWait(t,e)},this)},JSJaCHttpBindingConnection.prototype._reInitStreamWait=function(e,t){this.oDbg.log("checking for stream features");var i=e.responseXML.documentElement;if(this.oDbg.log(i),i.getElementsByTagNameNS){this.oDbg.log("checking with namespace");var n=i.getElementsByTagNameNS("http://etherx.jabber.org/streams","features").item(0);if(n)var r=n.getElementsByTagNameNS("urn:ietf:params:xml:ns:xmpp-bind","bind").item(0)}else{for(var a=i.getElementsByTagName("stream:features"),o=0,s=a.length;s>o;o++)if("http://etherx.jabber.org/streams"==a.item(o).namespaceURI||"http://etherx.jabber.org/streams"==a.item(o).getAttribute("xmlns")){var n=a.item(o);break}if(n)for(var r=n.getElementsByTagName("bind"),o=0,s=r.length;s>o;o++)if("urn:ietf:params:xml:ns:xmpp-bind"==r.item(o).namespaceURI||"urn:ietf:params:xml:ns:xmpp-bind"==r.item(o).getAttribute("xmlns")){r=r.item(o);break}}this.oDbg.log(n),this.oDbg.log(r),n?r?t():(this.oDbg.log("no bind feature - giving up",1),this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect")):this._sendEmpty(this._prepReInitStreamWait(t))},JSJaCHttpBindingConnection.prototype._resume=function(){0==this._pause&&this._rid>=this._last_rid&&(this._rid=this._last_rid-1),this._process()},JSJaCHttpBindingConnection.prototype._setHold=function(e){return!e||isNaN(e)||0>e?e=0:e>JSJACHBC_MAX_HOLD&&(e=JSJACHBC_MAX_HOLD),this._hold=e,this._hold},JSJaCHttpBindingConnection.prototype._setupRequest=function(e){var t=new Object,i=XmlHttp.create();try{i.open("POST",this._httpbase,e),i.setRequestHeader("Content-Type","text/xml; charset=utf-8")}catch(n){this.oDbg.log(n,1)}return t.r=i,this._rid++,t.rid=this._rid,t},JSJaCHttpBindingConnection.prototype._suspend=function(){if(0!=this._pause){var e=this._getFreeSlot();this._req[e]=this._setupRequest(!1);var t="<body xml:lang='"+XML_LANG+"' pause='"+this._pause+"' xmlns='http://jabber.org/protocol/httpbind' sid='"+this._sid+"' rid='"+this._rid+"'";for(JSJAC_HAVEKEYS&&(t+=" key='"+this._keys.getKey()+"'",this._keys.lastKey()&&(this._keys=new JSJaCKeys(hex_sha1,this.oDbg),t+=" newkey='"+this._keys.getKey()+"'")),t+=">";this._pQueue.length;){var i=this._pQueue[0];t+=i,this._pQueue=this._pQueue.slice(1,this._pQueue.length)}t+="</body>",this.oDbg.log("Disconnecting: "+t,4),this._req[e].r.send(t)}},JSJaCWebSocketConnection.prototype=new JSJaCConnection,JSJaCWebSocketConnection.prototype._cleanupWebSocket=function(){null!==this._ws&&(this._ws.onclose=null,this._ws.onerror=null,this._ws.onopen=null,this._ws.onmessage=null,this._ws.close(),this._ws=null)},JSJaCWebSocketConnection.prototype.connect=function(e){return this._setStatus("connecting"),this.domain=e.domain||"localhost",this.username=e.username,this.resource=e.resource,this.pass=e.password||e.pass,this.authzid=e.authzid||"",this.register=e.register,this.authhost=e.authhost||this.domain,this.authtype=e.authtype||"sasl",this.jid=this.username+"@"+this.domain,this.fulljid=this.jid+"/"+this.resource,e.allow_plain?this._allow_plain=e.allow_plain:this._allow_plain=JSJAC_ALLOW_PLAIN,
e.allow_scram?this._allow_scram=e.allow_scram:this._allow_scram=JSJAC_ALLOW_SCRAM,e.xmllang&&""!==e.xmllang?this._xmllang=e.xmllang:this._xmllang="en","undefined"==typeof WebSocket?void this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")):(this._ws=new WebSocket(this._httpbase,"xmpp"),this._ws.onclose=JSJaC.bind(this._onclose,this),this._ws.onerror=JSJaC.bind(this._onerror,this),void(this._ws.onopen=JSJaC.bind(this._onopen,this)))},JSJaCWebSocketConnection.prototype._onopen=function(){var e=this._getInitialRequestString();this.oDbg.log(e,4),this._ws.onmessage=JSJaC.bind(this._handleOpenStream,this),this._ws.send(e)},JSJaCWebSocketConnection.prototype._handleOpenStream=function(e){var t,i;return this.oDbg.log(e.data,4),t=e.data,t=t.substr(t.indexOf("<stream:stream")),"/>"!==t.substr(-2)&&"</stream:stream>"!==t.substr(-16)&&(t+="</stream:stream>"),(i=this._parseXml(t))?(this.streamid=i.getAttribute("id"),this.oDbg.log("got streamid: "+this.streamid,2),void(this._ws.onmessage=JSJaC.bind(this._handleInitialResponse,this))):void this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))},JSJaCWebSocketConnection.prototype._handleInitialResponse=function(e){var t=this._parseXml(e.data);return this._parseStreamFeatures(t)?(this._connected=!0,void(this.register?this._doInBandReg():this._doAuth())):void this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))},JSJaCWebSocketConnection.prototype.disconnect=function(){this._setStatus("disconnecting"),this.connected()&&(this._connected=!1,this.oDbg.log("Disconnecting",4),this._sendRaw("</stream:stream>",JSJaC.bind(this._cleanupWebSocket,this)),this.oDbg.log("Disconnected",2),this._handleEvent("ondisconnect"))},JSJaCWebSocketConnection.prototype._onclose=function(){this.oDbg.log("websocket closed",2),"disconnecting"!==this._status&&(this._connected=!1,this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")))},JSJaCWebSocketConnection.prototype._onerror=function(){this.oDbg.log("websocket error",1),this._connected=!1,this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))},JSJaCWebSocketConnection.prototype._onmessage=function(e){var t,i,n;if(t=e.data,this._setStatus("processing"),t&&""!==t){if(i=this._parseXml(t),i.namespaceURI===NS_STREAM&&"error"===i.localName)return i.getElementsByTagNameNS(NS_STREAMS,"conflict").length>0&&this._setStatus("session-terminate-conflict"),this._connected=!1,void this._handleEvent("onerror",JSJaCError("503","cancel","remote-stream-error"));n=JSJaCPacket.wrapNode(i),n&&(this.oDbg.log("async recv: "+e.data,4),this._handleEvent("packet_in",n),n.pType&&!this._handlePID(n)&&(this._handleEvent(n.pType()+"_in",n),this._handleEvent(n.pType(),n)))}},JSJaCWebSocketConnection.prototype._parseXml=function(e){var t;this.oDbg.log("Parsing: "+e,4);try{if(t=XmlDocument.create("stream",NS_STREAM),"</stream:stream>"==e.trim()){this.oDbg.log("session terminated",1),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto);try{DataStore.removeDB(MINI_HASH,"jsjac","state")}catch(i){}return this._connected=!1,this._handleEvent("onerror",JSJaCError("503","cancel","session-terminate")),this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),null}return-1===e.indexOf("<stream:stream")?(t.loadXML("<stream:stream xmlns:stream='"+NS_STREAM+"' xmlns='jabber:client'>"+e+"</stream:stream>"),t.documentElement.firstChild):(t.loadXML(e),t.documentElement)}catch(i){this.oDbg.log("Error: "+i),this._connected=!1,this._handleEvent("onerror",JSJaCError("500","wait","internal-service-error"))}return null},JSJaCWebSocketConnection.prototype._getInitialRequestString=function(){var e,t;return e=this.domain,this.authhost&&(e=this.authhost),t='<stream:stream to="'+e+'" xmlns="jabber:client" xmlns:stream="'+NS_STREAM+'"',("sasl"===this.authtype||"saslanon"===this.authtype)&&(t+=' version="1.0"'),t+=">"},JSJaCWebSocketConnection.prototype.send=function(e,t,i){if(this._ws.onmessage=JSJaC.bind(this._onmessage,this),!e||!e.pType)return this.oDbg.log("no packet: "+e,1),!1;if(!this.connected())return!1;t&&(e.getID()||e.setID("JSJaCID_"+this._ID++),this._registerPID(e,t,i));try{this._handleEvent(e.pType()+"_out",e),this._handleEvent("packet_out",e),this._ws.send(e.xml())}catch(n){return this.oDbg.log(n.toString(),1),!1}return!0},JSJaCWebSocketConnection.prototype.resume=function(){return!1},JSJaCWebSocketConnection.prototype.suspend=function(){return!1},JSJaCWebSocketConnection.prototype._doSASLAuthScramSha1S1=function(e){var t=this._parseXml(e.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthScramSha1S1,this)(t)},JSJaCWebSocketConnection.prototype._doSASLAuthScramSha1S2=function(e){var t=this._parseXml(e.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthScramSha1S2,this)(t)},JSJaCWebSocketConnection.prototype._doSASLAuthDigestMd5S1=function(e){var t=this._parseXml(e.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthDigestMd5S1,this)(t)},JSJaCWebSocketConnection.prototype._doSASLAuthDigestMd5S2=function(e){var t=this._parseXml(e.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthDigestMd5S2,this)(t)},JSJaCWebSocketConnection.prototype._doSASLAuthDone=function(e){var t=this._parseXml(e.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthDone,this)(t)},JSJaCWebSocketConnection.prototype._reInitStream=function(e){var t,i=this.domain;this.authhost&&(i=this.authhost),t='<stream:stream xmlns:stream="'+NS_STREAM+'" xmlns="jabber:client" to="'+i+'" version="1.0">',this._sendRaw(t,e)},JSJaCWebSocketConnection.prototype._sendRaw=function(e,t,i){return this._ws?(t&&(this._ws.onmessage=JSJaC.bind(t,this,i)),this._ws.send(e),!0):!1};var JSJaCUtils={xor:function(e,t){if(!e)return t;if(!t)return e;for(var i="",n=0;n<e.length;n++)i+=String.fromCharCode(e.charCodeAt(n)^t.charCodeAt(n));return i},cnonce:function(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i="",n=0;e>n;n++)i+=t.charAt(Math.round(Math.random((new Date).getTime())*(t.length-1)));return i},now:function(){return Date.now&&"function"==typeof Date.now?Date.now():(new Date).getTime()}};!function($){"use strict";var escape=/["\\\x00-\x1f\x7f-\x9f]/g,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},hasOwn=Object.prototype.hasOwnProperty;$.toJSON="object"==typeof JSON&&JSON.stringify?JSON.stringify:function(e){if(null===e)return"null";var t,i,n,r,a=$.type(e);if("undefined"!==a){if("number"===a||"boolean"===a)return String(e);if("string"===a)return $.quoteString(e);if("function"==typeof e.toJSON)return $.toJSON(e.toJSON());if("date"===a){var o=e.getUTCMonth()+1,s=e.getUTCDate(),c=e.getUTCFullYear(),p=e.getUTCHours(),l=e.getUTCMinutes(),u=e.getUTCSeconds(),h=e.getUTCMilliseconds();return 10>o&&(o="0"+o),10>s&&(s="0"+s),10>p&&(p="0"+p),10>l&&(l="0"+l),10>u&&(u="0"+u),100>h&&(h="0"+h),10>h&&(h="0"+h),'"'+c+"-"+o+"-"+s+"T"+p+":"+l+":"+u+"."+h+'Z"'}if(t=[],$.isArray(e)){for(i=0;i<e.length;i++)t.push($.toJSON(e[i])||"null");return"["+t.join(",")+"]"}if("object"==typeof e){for(i in e)if(hasOwn.call(e,i)){if(a=typeof i,"number"===a)n='"'+i+'"';else{if("string"!==a)continue;n=$.quoteString(i)}a=typeof e[i],"function"!==a&&"undefined"!==a&&(r=$.toJSON(e[i]),t.push(n+":"+r))}return"{"+t.join(",")+"}"}}},$.evalJSON="object"==typeof JSON&&JSON.parse?JSON.parse:function(str){return eval("("+str+")")},$.secureEvalJSON="object"==typeof JSON&&JSON.parse?JSON.parse:function(str){var filtered=str.replace(/\\["\\\/bfnrtu]/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"");if(/^[\],:{}\s]*$/.test(filtered))return eval("("+str+")");throw new SyntaxError("Error parsing JSON, source is not valid.")},$.quoteString=function(e){return e.match(escape)?'"'+e.replace(escape,function(e){var t=meta[e];return"string"==typeof t?t:(t=e.charCodeAt(),"\\u00"+Math.floor(t/16).toString(16)+(t%16).toString(16))})+'"':'"'+e+'"'}}(jQuery),jQuery.fn.extend({everyTime:function(e,t,i,n){return this.each(function(){jQuery.timer.add(this,e,t,i,n)})},oneTime:function(e,t,i){return this.each(function(){jQuery.timer.add(this,e,t,i,1)})},stopTime:function(e,t){return this.each(function(){jQuery.timer.remove(this,e,t)})}}),jQuery.extend({timer:{global:[],guid:1,dataKey:"jQuery.timer",regex:/^([0-9]+(?:\.[0-9]*)?)\s*(.*s)?$/,powers:{ms:1,cs:10,ds:100,s:1e3,das:1e4,hs:1e5,ks:1e6},timeParse:function(e){if(void 0==e||null==e)return null;var t=this.regex.exec(jQuery.trim(e.toString()));if(t[2]){var i=parseFloat(t[1]),n=this.powers[t[2]]||1;return i*n}return e},add:function(e,t,i,n,r){var a=0;if(jQuery.isFunction(i)&&(r||(r=n),n=i,i=t),t=jQuery.timer.timeParse(t),!("number"!=typeof t||isNaN(t)||0>t)){("number"!=typeof r||isNaN(r)||0>r)&&(r=0),r=r||0;var o=jQuery.data(e,this.dataKey)||jQuery.data(e,this.dataKey,{});o[i]||(o[i]={}),n.timerID=n.timerID||this.guid++;var s=function(){(++a>r&&0!==r||n.call(e,a)===!1)&&jQuery.timer.remove(e,i,n)};s.timerID=n.timerID,o[i][n.timerID]||(o[i][n.timerID]=window.setInterval(s,t)),this.global.push(e)}},remove:function(e,t,i){var n,r=jQuery.data(e,this.dataKey);if(r){if(t){if(r[t]){if(i)i.timerID&&(window.clearInterval(r[t][i.timerID]),delete r[t][i.timerID]);else for(var i in r[t])window.clearInterval(r[t][i]),delete r[t][i];for(n in r[t])break;n||(n=null,delete r[t])}}else for(t in r)this.remove(e,t,i);for(n in r)break;n||jQuery.removeData(e,this.dataKey)}}}}),jQuery(window).bind("unload",function(){jQuery.each(jQuery.timer.global,function(e,t){jQuery.timer.remove(t)})}),function(e){"function"==typeof define&&define.amd?define(["jquery"],e):e(jQuery)}(function(e){function t(t){return e.isFunction(t)||"object"==typeof t?t:{top:t,left:t}}var i=e.scrollTo=function(t,i,n){return e(window).scrollTo(t,i,n)};return i.defaults={axis:"xy",duration:parseFloat(e.fn.jquery)>=1.3?0:1,limit:!0},i.window=function(t){return e(window)._scrollable()},e.fn._scrollable=function(){return this.map(function(){var t=this,i=!t.nodeName||-1!=e.inArray(t.nodeName.toLowerCase(),["iframe","#document","html","body"]);if(!i)return t;var n=(t.contentWindow||t).document||t.ownerDocument||t;return/webkit/i.test(navigator.userAgent)||"BackCompat"==n.compatMode?n.body:n.documentElement})},e.fn.scrollTo=function(n,r,a){return"object"==typeof r&&(a=r,r=0),"function"==typeof a&&(a={onAfter:a}),"max"==n&&(n=9e9),a=e.extend({},i.defaults,a),r=r||a.duration,a.queue=a.queue&&a.axis.length>1,a.queue&&(r/=2),a.offset=t(a.offset),a.over=t(a.over),this._scrollable().each(function(){function o(e){p.animate(u,r,a.easing,e&&function(){e.call(this,l,a)})}if(null!=n){var s,c=this,p=e(c),l=n,u={},h=p.is("html,body");switch(typeof l){case"number":case"string":if(/^([+-]=?)?\d+(\.\d+)?(px|%)?$/.test(l)){l=t(l);break}if(l=e(l,this),!l.length)return;case"object":(l.is||l.style)&&(s=(l=e(l)).offset())}var m=e.isFunction(a.offset)&&a.offset(c,l)||a.offset;e.each(a.axis.split(""),function(e,t){var n="x"==t?"Left":"Top",r=n.toLowerCase(),d="scroll"+n,_=c[d],g=i.max(c,t);if(s)u[d]=s[r]+(h?0:_-p.offset()[r]),a.margin&&(u[d]-=parseInt(l.css("margin"+n))||0,u[d]-=parseInt(l.css("border"+n+"Width"))||0),u[d]+=m[r]||0,a.over[r]&&(u[d]+=l["x"==t?"width":"height"]()*a.over[r]);else{var f=l[r];u[d]=f.slice&&"%"==f.slice(-1)?parseFloat(f)/100*g:f}a.limit&&/^\d+$/.test(u[d])&&(u[d]=u[d]<=0?0:Math.min(u[d],g)),!e&&a.queue&&(_!=u[d]&&o(a.onAfterFirst),delete u[d])}),o(a.onAfter)}}).end()},i.max=function(t,i){var n="x"==i?"Width":"Height",r="scroll"+n;if(!e(t).is("html,body"))return t[r]-e(t)[n.toLowerCase()]();var a="client"+n,o=t.ownerDocument.documentElement,s=t.ownerDocument.body;return Math.max(o[r],s[r])-Math.min(o[a],s[a])},i});var System=function(){var e={};return e.location=function(){try{var e=window.location.href;return-1!=e.indexOf("?")&&(e=e.split("?")[0]),-1!=e.indexOf("#")&&(e=e.split("#")[0]),e.match(/(.+)\/$/)||(e+="/"),e}catch(t){Console.error("System.location",t)}},e.isDeveloper=function(){try{return"on"===DEVELOPER}catch(e){Console.error("System.isDeveloper",e)}},e}(),JappixSystem=System,NS_PROTOCOL="http://jabber.org/protocol/",NS_FEATURES="http://jabber.org/features/",NS_CLIENT="jabber:client",NS_IQ="jabber:iq:",NS_X="jabber:x:",NS_IETF="urn:ietf:params:xml:ns:",NS_IETF_XMPP=NS_IETF+"xmpp-",NS_XMPP="urn:xmpp:",NS_STORAGE="storage:",NS_BOOKMARKS=NS_STORAGE+"bookmarks",NS_ROSTERNOTES=NS_STORAGE+"rosternotes",NS_JAPPIX="jappix:",NS_INBOX=NS_JAPPIX+"inbox",NS_OPTIONS=NS_JAPPIX+"options",NS_DISCO_ITEMS=NS_PROTOCOL+"disco#items",NS_DISCO_INFO=NS_PROTOCOL+"disco#info",NS_VCARD="vcard-temp",NS_VCARD_P=NS_VCARD+":x:update",NS_IETF_VCARD4=NS_IETF+"vcard-4.0",NS_XMPP_VCARD4=NS_XMPP+"vcard4",NS_URN_ADATA=NS_XMPP+"avatar:data",NS_URN_AMETA=NS_XMPP+"avatar:metadata",NS_AUTH=NS_IQ+"auth",NS_AUTH_ERROR=NS_IQ+"auth:error",NS_REGISTER=NS_IQ+"register",NS_SEARCH=NS_IQ+"search",NS_ROSTER=NS_IQ+"roster",NS_PRIVACY=NS_IQ+"privacy",NS_PRIVATE=NS_IQ+"private",NS_VERSION=NS_IQ+"version",NS_TIME=NS_IQ+"time",NS_LAST=NS_IQ+"last",NS_IQDATA=NS_IQ+"data",NS_XDATA=NS_X+"data",NS_IQOOB=NS_IQ+"oob",NS_XOOB=NS_X+"oob",NS_DELAY=NS_X+"delay",NS_EXPIRE=NS_X+"expire",NS_EVENT=NS_X+"event",NS_XCONFERENCE=NS_X+"conference",NS_STATS=NS_PROTOCOL+"stats",NS_MUC=NS_PROTOCOL+"muc",NS_MUC_USER=NS_MUC+"#user",NS_MUC_ADMIN=NS_MUC+"#admin",NS_MUC_OWNER=NS_MUC+"#owner",NS_MUC_CONFIG=NS_MUC+"#roomconfig",NS_PUBSUB=NS_PROTOCOL+"pubsub",NS_PUBSUB_EVENT=NS_PUBSUB+"#event",NS_PUBSUB_OWNER=NS_PUBSUB+"#owner",NS_PUBSUB_NMI=NS_PUBSUB+"#node-meta-info",NS_PUBSUB_NC=NS_PUBSUB+"#node_config",NS_PUBSUB_CN=NS_PUBSUB+"#config-node",NS_PUBSUB_RI=NS_PUBSUB+"#retrieve-items",NS_COMMANDS=NS_PROTOCOL+"commands",NS_BOSH=NS_PROTOCOL+"httpbind",NS_STREAM="http://etherx.jabber.org/streams",NS_URN_TIME=NS_XMPP+"time",NS_URN_PING=NS_XMPP+"ping",NS_URN_MBLOG=NS_XMPP+"microblog:0",NS_URN_INBOX=NS_XMPP+"inbox",NS_URN_FORWARD=NS_XMPP+"forward:0",NS_URN_MAM=NS_XMPP+"mam:tmp",NS_URN_DELAY=NS_XMPP+"delay",NS_URN_RECEIPTS=NS_XMPP+"receipts",NS_URN_CARBONS=NS_XMPP+"carbons:2",NS_URN_CORRECT=NS_XMPP+"message-correct:0",NS_URN_IDLE=NS_XMPP+"idle:1",NS_URN_REACH=NS_XMPP+"reach:0",NS_URN_MARKERS=NS_XMPP+"chat-markers:0",NS_URN_ATTENTION=NS_XMPP+"attention:0",NS_URN_HINTS=NS_XMPP+"hints",NS_RSM=NS_PROTOCOL+"rsm",NS_IPV6="ipv6",NS_XHTML="http://www.w3.org/1999/xhtml",NS_XHTML_IM=NS_PROTOCOL+"xhtml-im",NS_CHATSTATES=NS_PROTOCOL+"chatstates",NS_HTTP_AUTH=NS_PROTOCOL+"http-auth",NS_ROSTERX=NS_PROTOCOL+"rosterx",NS_MOOD=NS_PROTOCOL+"mood",NS_ACTIVITY=NS_PROTOCOL+"activity",NS_TUNE=NS_PROTOCOL+"tune",NS_GEOLOC=NS_PROTOCOL+"geoloc",NS_NICK=NS_PROTOCOL+"nick",NS_NOTIFY="+notify",NS_CAPS=NS_PROTOCOL+"caps",NS_ATOM="http://www.w3.org/2005/Atom",NS_STANZAS=NS_IETF_XMPP+"stanzas",NS_STREAMS=NS_IETF_XMPP+"streams",NS_TLS=NS_IETF_XMPP+"tls",NS_SASL=NS_IETF_XMPP+"sasl",NS_SESSION=NS_IETF_XMPP+"session",NS_BIND=NS_IETF_XMPP+"bind",NS_FEATURE_IQAUTH=NS_FEATURES+"iq-auth",NS_FEATURE_IQREGISTER=NS_FEATURES+"iq-register",NS_FEATURE_COMPRESS=NS_FEATURES+"compress",NS_COMPRESS=NS_PROTOCOL+"compress",NS_METRONOME_MAM_PURGE="http://metronome.im/protocol/mam-purge",LOCALES_AVAILABLE_ID=[],LOCALES_AVAILABLE_NAMES=[],XML_LANG=null,JAPPIX_STATIC=null,JAPPIX_VERSION=null,JAPPIX_MAX_FILE_SIZE=null,JAPPIX_MAX_UPLOAD=null,SERVICE_NAME=null,SERVICE_DESC=null,OWNER_NAME=null,OWNER_WEBSITE=null,LEGAL=null,JAPPIX_RESOURCE=null,LOCK_HOST=null,ANONYMOUS=null,HTTP_AUTH=null,REGISTRATION=null,BOSH_PROXY=null,MANAGER_LINK=null,GROUPCHATS_JOIN=null,GROUPCHATS_SUGGEST=null,ENCRYPTION=null,HTTPS_STORAGE=null,HTTPS_FORCE=null,COMPRESSION=null,ADS_ENABLE=null,GADS_CLIENT=null,GADS_SLOT=null,MULTI_FILES=null,DEVELOPER=null,REGISTER_API=null,HOST_MAIN=null,HOST_MUC=null,HOST_PUBSUB=null,HOST_VJUD=null,HOST_ANONYMOUS=null,HOST_STUN=null,HOST_TURN=null,HOST_TURN_USERNAME=null,HOST_TURN_PASSWORD=null,HOST_BOSH=null,HOST_BOSH_MAIN=null,HOST_BOSH_MINI=null,HOST_WEBSOCKET=null,HOST_STATIC=null,HOST_UPLOAD=null,ANONYMOUS_ROOM=null,ANONYMOUS_NICK=null,JAPPIX_LOCATION=JappixSystem.location(),JAPPIX_MINI_CSS=null,BOSH_SAME_ORIGIN=!1,ERR_BAD_REQUEST=STANZA_ERROR("400","modify","bad-request"),ERR_CONFLICT=STANZA_ERROR("409","cancel","conflict"),ERR_FEATURE_NOT_IMPLEMENTED=STANZA_ERROR("501","cancel","feature-not-implemented"),ERR_FORBIDDEN=STANZA_ERROR("403","auth","forbidden"),ERR_GONE=STANZA_ERROR("302","modify","gone"),ERR_INTERNAL_SERVER_ERROR=STANZA_ERROR("500","wait","internal-server-error"),ERR_ITEM_NOT_FOUND=STANZA_ERROR("404","cancel","item-not-found"),ERR_JID_MALFORMED=STANZA_ERROR("400","modify","jid-malformed"),ERR_NOT_ACCEPTABLE=STANZA_ERROR("406","modify","not-acceptable"),ERR_NOT_ALLOWED=STANZA_ERROR("405","cancel","not-allowed"),ERR_NOT_AUTHORIZED=STANZA_ERROR("401","auth","not-authorized"),ERR_PAYMENT_REQUIRED=STANZA_ERROR("402","auth","payment-required"),ERR_RECIPIENT_UNAVAILABLE=STANZA_ERROR("404","wait","recipient-unavailable"),ERR_REDIRECT=STANZA_ERROR("302","modify","redirect"),ERR_REGISTRATION_REQUIRED=STANZA_ERROR("407","auth","registration-required"),ERR_REMOTE_SERVER_NOT_FOUND=STANZA_ERROR("404","cancel","remote-server-not-found"),ERR_REMOTE_SERVER_TIMEOUT=STANZA_ERROR("504","wait","remote-server-timeout"),ERR_RESOURCE_CONSTRAINT=STANZA_ERROR("500","wait","resource-constraint"),ERR_SERVICE_UNAVAILABLE=STANZA_ERROR("503","cancel","service-unavailable"),ERR_SUBSCRIPTION_REQUIRED=STANZA_ERROR("407","auth","subscription-required"),ERR_UNEXPECTED_REQUEST=STANZA_ERROR("400","wait","unexpected-request"),DataStore=function(){var e={};return e._db_emulated={},e._persistent_emulated={},e._adapter=function(e,t){try{var i=!e;this.key=function(n){if(i){if(n>=this.length)return null;var r=0;for(var a in t)if(r++==n)return a;return null}return e.key(n)},this.getItem=function(n){return i?void 0!==t[n]?t[n]:null:e.getItem(n)},this.setItem=function(n,r){i?(n in t||this.length++,t[n]=r+""):(e.setItem(n,r),this.length=e.length)},this.removeItem=function(n){i?n in t&&(this.length--,delete t[n]):(e.removeItem(n),this.length=e.length)},this.clear=function(){i?(this.length=0,t={}):(e.clear(),this.length=e.length)},this.length=i?0:e.length}catch(n){Console.error("DataStore._adapter",n)}},e.storageDB=new e._adapter(window.sessionStorage?sessionStorage:null,e._db_emulated),e.storagePersistent=new e._adapter(window.localStorage?localStorage:null,e._persistent_emulated),e.hasDB=function(){var t=!1;try{e.storageDB.setItem("hasdb_check","ok"),e.storageDB.removeItem("hasdb_check"),t=!0}catch(i){Console.error("DataStore.hasDB",i)}finally{return t}},e.getDB=function(t,i,n){try{try{return e.storageDB.getItem(t+"_"+i+"_"+n)}catch(r){Console.error("Error while getting a temporary database entry ("+t+" -> "+i+" -> "+n+")",r)}return null}catch(r){Console.error("DataStore.getDB",r)}},e.setDB=function(t,i,n,r){try{try{return e.storageDB.setItem(t+"_"+i+"_"+n,r),!0}catch(a){Console.error("Error while writing a temporary database entry ("+t+" -> "+i+" -> "+n+")",a)}return!1}catch(a){Console.error("DataStore.setDB",a)}},e.removeDB=function(t,i,n){try{try{return e.storageDB.removeItem(t+"_"+i+"_"+n),!0}catch(r){Console.error("Error while removing a temporary database entry ("+t+" -> "+i+" -> "+n+")",r)}return!1}catch(r){Console.error("DataStore.removeDB",r)}},e.existDB=function(t,i,n){try{return null!==e.getDB(t,i,n)}catch(r){Console.error("DataStore.existDB",r)}},e.resetDB=function(){try{try{return e.storageDB.clear(),Console.info("Temporary database cleared."),!0}catch(t){return Console.error("Error while clearing temporary database",t),!1}}catch(t){Console.error("DataStore.resetDB",t)}},e.hasPersistent=function(){var t=!1;try{e.storagePersistent.setItem("haspersistent_check","ok"),e.storagePersistent.removeItem("haspersistent_check"),t=!0}catch(i){Console.error("DataStore.hasPersistent",i)}finally{return t}},e.getPersistent=function(t,i,n){try{try{return e.storagePersistent.getItem(t+"_"+i+"_"+n)}catch(r){return Console.error("Error while getting a persistent database entry ("+t+" -> "+i+" -> "+n+")",r),null}}catch(r){Console.error("DataStore.getPersistent",r)}},e.setPersistent=function(t,i,n,r){try{try{return e.storagePersistent.setItem(t+"_"+i+"_"+n,r),!0}catch(a){Console.warn("Retrying: could not write a persistent database entry ("+t+" -> "+i+" -> "+n+")",a),e.flushPersistent();try{return e.storagePersistent.setItem(t+" -> "+i+"_"+n,r),!0}catch(o){Console.error("Aborted: error while writing a persistent database entry ("+t+" -> "+i+" -> "+n+")",o)}}return!1}catch(a){Console.error("DataStore.setPersistent",a)}},e.removePersistent=function(t,i,n){try{try{return e.storagePersistent.removeItem(t+"_"+i+"_"+n),!0}catch(r){Console.error("Error while removing a persistent database entry ("+t+" -> "+i+" -> "+n+")",r)}return!1}catch(r){Console.error("DataStore.removePersistent",r)}},e.existPersistent=function(t,i,n){try{return null!==e.getPersistent(t,i,n)}catch(r){Console.error("DataStore.existPersistent",r)}},e.resetPersistent=function(){try{try{return e.storagePersistent.clear(),Console.info("Persistent database cleared."),!0}catch(t){Console.error("Error while clearing persistent database",t)}return!1}catch(t){Console.error("DataStore.resetPersistent",t)}},e.flushPersistent=function(){try{try{var t=e.getPersistent("global","session",1);return e.resetPersistent(),t&&e.setPersistent("global","session",1,t),Console.info("Persistent database flushed."),!0}catch(i){Console.error("Error while flushing persistent database",i)}return!1}catch(i){Console.error("DataStore.flushPersistent",i)}},e}(),JappixDataStore=DataStore,BrowserDetect={init:function(){this.browser=this.searchString(this.dataBrowser)||"An unknown browser",this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version",this.OS=this.searchString(this.dataOS)||"an unknown OS"},searchString:function(e){for(var t=0;t<e.length;t++){var i=e[t].string,n=e[t].prop;if(this.versionSearchString=e[t].versionSearch||e[t].identity,i){if(-1!=i.indexOf(e[t].subString))return e[t].identity}else if(n)return e[t].identity}},searchVersion:function(e){var t=e.indexOf(this.versionSearchString);if(-1!=t)return parseFloat(e.substring(t+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};BrowserDetect.init();var Console=function(){var e=this;return e._available="undefined"!=typeof window.console,e._has=e._available&&JappixSystem.isDeveloper(),e._console=e._available?console:{},e._adapter=function(t){if(!e._has)return function(){};var i=null;try{switch(t){case 0:i=console.warn;break;case 1:i=console.error;break;case 2:i=console.info;break;case 3:i=console.log;break;case 4:i=console.debug}}catch(n){i=function(){}}return i.bind(e._console)},e.warn=e._adapter(0),e.error=e._adapter(1),e.info=e._adapter(2),e.log=e._adapter(3),e.debug=e._adapter(4),e}(),JappixConsole=Console,Common=function(){var e={};return e.R_DOMAIN_NAME=/^(([a-zA-Z0-9-\.]+)\.)?[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9]\.[a-zA-Z]{2,}$/i,e.exists=function(e){var t=!1;try{jQuery(e).size()>0&&(t=!0)}catch(i){Console.error("Common.exists",i)}finally{return t}},e.isConnected=function(){connected=!1;try{"undefined"!=typeof con&&con&&con.connected()&&(connected=!0)}catch(e){Console.error("Common.isConnected",e)}finally{return connected}},e.hasWebSocket=function(){has_websocket=!1;try{HOST_WEBSOCKET&&"undefined"!=typeof window.WebSocket&&(has_websocket=!0)}catch(e){Console.error("Common.hasWebSocket",e)}finally{return has_websocket}},e.isFocused=function(){has_focus=!0;try{document.hasFocus()||(has_focus=!1)}catch(e){Console.error("Common.isFocused",e)}finally{return has_focus}},e.isDomain=function(t){is_domain=!1;try{t.match(e.R_DOMAIN_NAME)&&(is_domain=!0)}catch(i){Console.error("Common.isDomain",i)}finally{return is_domain}},e.generateXID=function(t,i){try{return t=t.toLowerCase(),t&&-1===t.indexOf("@")?"groupchat"==i?t+"@"+HOST_MUC:e.isDomain(t)===!0?t:t+"@"+HOST_MAIN:t}catch(n){Console.error("Common.generateXID",n)}},e._e=function(e){try{return e}catch(t){Console.error("Common._e",t)}},e.printf=function(e,t){try{return e.replace("%s",t)}catch(i){Console.error("Common.printf",i)}},e.strAfterLast=function(e,t){try{if(!e||!t)return"";var i=t.lastIndexOf(e),n=t;return i>=0&&(n=t.substr(i+1)),n}catch(r){Console.error("Common.strAfterLast",r)}},e.explodeThis=function(e,t,i){try{var n=t.indexOf(e);return-1!==n&&(t=0===i?t.substr(0,n):t.substr(n+1)),t}catch(r){Console.error("Common.explodeThis",r)}},e.cutResource=function(t){try{return e.explodeThis("/",t,0)}catch(i){Console.error("Common.cutResource",i)}},e.thisResource=function(t){resource="";try{e.isFullXID(t)&&(resource=e.explodeThis("/",t,1))}catch(i){Console.error("Common.thisResource",i)}finally{return resource}},e.isFullXID=function(e){try{return-1!==e.indexOf("/")}catch(t){return Console.error("Common.isFullXID",t),!1}},e.nodeprep=function(e){try{if(!e)return e;var t=['"',"&","'","/",":","<",">","@"];for(var i in t)e=e.replace(t[i],"");return e=e.toLowerCase()}catch(n){Console.error("Common.nodeprep",n)}},e.encodeQuotes=function(e){try{return(e+"").htmlEnc()}catch(t){Console.error("Common.encodeQuotes",t)}},e.escapeQuotes=function(t){try{return escape(e.encodeQuotes(t))}catch(i){Console.error("Common.escapeQuotes",i)}},e.unescapeQuotes=function(e){try{return unescape(e)}catch(t){Console.error("Common.unescapeQuotes",t)}},e.bareXID=function(t){try{return t=e.cutResource(t),-1!==t.indexOf("@")&&(t=e.nodeprep(e.getXIDNick(t,!0))+"@"+e.getXIDHost(t)),t}catch(i){Console.error("Common.bareXID",i)}},e.fullXID=function(t){try{var i=e.bareXID(t),n=e.thisResource(t);return n&&(i+="/"+n),i}catch(r){Console.error("Common.fullXID",r)}},e.getXIDNick=function(t,i){try{return i!==!0&&t.match(/\\40/)?e.explodeThis("\\40",t,0):e.explodeThis("@",t,0)}catch(n){Console.error("Common.getXIDNick",n)}},e.getXIDHost=function(t){try{return e.explodeThis("@",t,1)}catch(i){Console.error("Common.getXIDHost",i)}},e.isRTL=function(){try{return"default:RTL"==e._e("default:LTR")}catch(t){Console.error("Common.isRTL",t)}},e.allowedAnonymous=function(){try{return"on"==ANONYMOUS}catch(e){Console.error("Common.allowedAnonymous",e)}},e.lockHost=function(){try{return"on"==LOCK_HOST}catch(e){Console.error("Common.lockHost",e)}},e.getXID=function(){try{return con.username&&con.domain?con.username+"@"+con.domain:""}catch(e){Console.error("Common.getXID",e)}},e.getFullXID=function(){try{var t=e.getXID();return t?t+"/"+con.resource:""}catch(i){Console.error("Common.getFullXID",i)}},e.generateColor=function(e){try{for(var t=new Array("ac0000","a66200","007703","00705f","00236b","4e005c"),i=0,n=0;n<e.length;n++)i+=e.charCodeAt(n);var r="#"+t[i%t.length];return r}catch(a){Console.error("Common.generateColor",a)}},e.isGateway=function(e){is_gateway=!0;try{-1!==e.indexOf("@")&&(is_gateway=!1)}catch(t){Console.error("Common.isGateway",t)}finally{return is_gateway}},e.getStanzaFrom=function(t){try{var i=t.getFrom();return i||(i=e.getXID()),i}catch(n){Console.error("Common.getStanzaFrom",n)}},e.isSafeStanza=function(t){var i=!1;try{var n=e.getStanzaFrom(t);i=!(n&&n!=con.domain&&n!=e.getXID())}catch(r){Console.error("Common.isSafeStanza",r)}finally{return i}},e.padZero=function(e){try{return e>-10&&0>e?"-0"+-1*e:10>e&&e>=0?"0"+e:e}catch(t){Console.error("Common.padZero",t)}},e.escapeRegex=function(e){var t=[];try{if(e instanceof Array)for(t=[e.length],i=0;i<e.length;i++)try{t[i]=Common.escapeRegex(e[i])}catch(n){Console.error("Common.escapeRegex",n),t[i]=null}else try{t=e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}catch(n){Console.error("Common.escapeRegex[inner]",n)}}catch(n){Console.error("Common.escapeRegex",n)}finally{return t}},e.randomArrayValue=function(e){try{return e[Math.floor(Math.random()*e.length)]}catch(t){Console.error("Common.randomArrayValue",t)}},e.isMobile=function(){is_mobile=!1;try{is_mobile=/Android|iPhone|iPod|iPad|Windows Phone|BlackBerry|Bada|Maemo|Meego|webOS/i.test(navigator.userAgent)}catch(e){Console.error("Common.isMobile",e)}finally{return is_mobile}},e.xmlToString=function(e){xml_str=null;try{window.XMLSerializer&&(xml_str=(new XMLSerializer).serializeToString(e)),window.ActiveXObject&&(xml_str=e.xml)}catch(t){Console.error("Common.xmlToString",t)}finally{return xml_str}},e.XMLFromString=function(e){try{if(!e)return"";if(e.match(/^<\?xml/i)||(e='<?xml version="1.0"?>'+e),window.DOMParser)return(new DOMParser).parseFromString(e,"text/xml");if(window.ActiveXObject){var t=new ActiveXObject("Microsoft.XMLDOM");return t.loadXML(e),t}}catch(i){return Console.error("Common.XMLFromString",i),""}},e.typewatch=function(e){try{var t=0;return function(e,i){clearTimeout(t),t=setTimeout(e,i)}}catch(i){Console.error("Common.typewatch",i)}},e.htmlentities=function(e){return $("<div/>").text(e+"").html()},e}(),JappixCommon=Common,DateUtils=function(){var e={};return e.last_activity=0,e.presence_last_activity=0,e.extractStamp=function(e){try{return Math.round(e.getTime()/1e3)}catch(t){Console.error("DateUtils.extractStamp",t)}},e.extractTime=function(e){try{return e.toLocaleTimeString()}catch(t){Console.error("DateUtils.extractTime",t)}},e.getTimeStamp=function(){try{return e.extractStamp(new Date)}catch(t){Console.error("DateUtils.getTimeStamp",t)}},e.getLastActivity=function(){try{return 0===e.last_activity?0:e.getTimeStamp()-e.last_activity}catch(t){Console.error("DateUtils.getLastActivity",t)}},e.getLastActivityDate=function(){try{var t=e.last_activity||e.getTimeStamp(),i=new Date;return i.setTime(1e3*t),e.getDatetime(i,"utc")}catch(n){Console.error("DateUtils.getLastActivityDate",n)}},e.getPresenceLast=function(){try{return 0===e.presence_last_activity?0:e.getTimeStamp()-e.presence_last_activity}catch(t){Console.error("DateUtils.getPresenceLast",t)}},e.getDatetime=function(e,t){var i,n,r,a,o,s,c=null;try{return"utc"==t?(i=e.getUTCFullYear(),n=e.getUTCMonth(),r=e.getUTCDate(),a=e.getUTCHours(),o=e.getUTCMinutes(),s=e.getUTCSeconds()):(i=e.getFullYear(),n=e.getMonth(),r=e.getDate(),a=e.getHours(),o=e.getMinutes(),s=e.getSeconds()),c=i+"-",c+=Common.padZero(n+1)+"-",c+=Common.padZero(r)+"T",c+=Common.padZero(a)+":",c+=Common.padZero(o)+":",c+=Common.padZero(s)+"Z"}catch(p){Console.error("DateUtils.getDatetime",p)}},e.getXMPPTime=function(t){try{return e.getDatetime(new Date,t)}catch(i){Console.error("DateUtils.getXMPPTime",i)}},e.getCompleteTime=function(){try{var e=new Date,t=Common.padZero(e.getHours())+":";return t+=Common.padZero(e.getMinutes())+":",t+=Common.padZero(e.getSeconds())}catch(i){Console.error("DateUtils.getCompleteTime",i)}},e.getTZO=function(){try{var e=new Date,t=e.getTimezoneOffset(),i="",n=0,r=0;0>t&&(t=-1*t,i="+");var a=new Date(60*t*1e3);return n=a.getHours()-1,r=a.getMinutes(),tzo=i+Common.padZero(n)+":"+Common.padZero(r),tzo}catch(o){Console.error("DateUtils.getTZO",o)}},e.difference=function(e,t){try{return(new Date).clearTime().addSeconds(t>0?e-t:0);
}catch(i){Console.error("DateUtils.difference",i)}},e.parse=function(e){try{var t=Date.jab2date(e),i=t.toLocaleDateString()+" ("+t.toLocaleTimeString()+")";return i}catch(n){Console.error("DateUtils.parse",n)}},e.parseDay=function(e){try{var t=Date.jab2date(e),i=t.toLocaleDateString();return i}catch(n){Console.error("DateUtils.parseDay",n)}},e.parseTime=function(e){try{var t=Date.jab2date(e),i=t.toLocaleTimeString();return i}catch(n){Console.error("DateUtils.parseTime",n)}},e.relative=function(t){try{var i=Date.jab2date(e.getXMPPTime("utc")),n=i.getDate(),r=i.getTime(),a=Date.jab2date(t),o=a.getDate(),s=a.getTime(),c=a.toLocaleTimeString(),p=Math.round((r-s)/864e5);return isNaN(s)||isNaN(p)?e.getCompleteTime():n==o?c:1>=p?Common._e("Yesterday")+" - "+c:7>=p?Common.printf(Common._e("%s days ago"),p)+" - "+c:a.toLocaleDateString()+" - "+c}catch(l){Console.error("DateUtils.relative",l)}},e.readMessageDelay=function(e,t){try{var i,n;if(n=jQuery(e).find('delay[xmlns="'+NS_URN_DELAY+'"]:first').attr("stamp"))i=n;else{var r=jQuery(e).find('x[xmlns="'+NS_DELAY+'"]:first').attr("stamp");r&&(i=r.replace(/^(\w{4})(\w{2})(\w{2})T(\w{2}):(\w{2}):(\w{2})Z?(\S+)?/,"$1-$2-$3T$4:$5:$6Z$7"))}return t===!0&&i?Date.jab2date(i):i}catch(a){Console.error("DateUtils.readMessageDelay",a)}},e}(),JappixDateUtils=DateUtils,Links=function(){var e={};return e.apply=function(e,t,i){try{var n;return i=i?' style="'+i+'"':"",n="xhtml-im"!=t?' target="_blank"':"",e=e.replace(/(\s|<br \/>|^)(([a-zA-Z0-9\._-]+)@([a-zA-Z0-9\.\/_-]+))(,|\s|$)/gi,'$1<a href="xmpp:$2" target="_blank"'+i+">$2</a>$5"),e=e.replace(/(\s|<br \/>|^|\()((https?|ftp|file|xmpp|irc|mailto|vnc|webcal|ssh|ldap|smb|magnet|spotify)(:)([^<>'"\s\)]+))/gim,'$1<a href="$2"'+n+i+">$2</a>")}catch(r){Console.error("Links.apply",r)}},e}(),JappixLinks=Links,MINI_DISCONNECT=!1,MINI_AUTOCONNECT=!1,MINI_SHOWPANE=!1,MINI_INITIALIZED=!1,MINI_ROSTER_INIT=!1,MINI_ROSTER_NOGROUP="jm_nogroup",MINI_ANONYMOUS=!1,MINI_ANIMATE=!1,MINI_RANDNICK=!1,MINI_GROUPCHAT_PRESENCE=!1,MINI_DISABLE_MOBILE=!1,MINI_NICKNAME="",MINI_TITLE=null,MINI_DOMAIN=null,MINI_USER=null,MINI_PASSWORD=null,MINI_HASH=null,MINI_ACTIVE=null,MINI_RECONNECT=0,MINI_RECONNECT_MAX=100,MINI_RECONNECT_INTERVAL=1,MINI_PIXEL_STREAM_DURATION=300,MINI_PIXEL_STREAM_INTERVAL=7200,MINI_QUEUE=[],MINI_CHATS=[],MINI_GROUPCHATS=[],MINI_SUGGEST_CHATS=[],MINI_SUGGEST_GROUPCHATS=[],MINI_SUGGEST_PASSWORDS=[],MINI_PASSWORDS=[],MINI_PRIORITY=1,MINI_RESOURCE=JAPPIX_RESOURCE+" Mini",MINI_ERROR_LINK="https://mini.jappix.com/issues",JappixMini=function(){var e={};return e.setupCon=function(t){try{t.registerHandler("message",e.handleMessage),t.registerHandler("presence",e.handlePresence),t.registerHandler("iq",e.handleIQ),t.registerHandler("onerror",e.handleError),t.registerHandler("onconnect",e.connected)}catch(i){JappixConsole.error("JappixMini.setupCon",i)}},e.connect=function(t,i,n){try{oArgs={},BOSH_SAME_ORIGIN=Origin.isSame(oArgs.httpbase),con=new JSJaCHttpBindingConnection({httpbase:HOST_BOSH_MINI||HOST_BOSH}),e.setupCon(con);var r="Explorer"!=BrowserDetect.browser,a=null;if(r&&(a=JappixDataStore.getDB(MINI_HASH,"jappix-mini","resource")),a||(a=MINI_RESOURCE+" ("+(new Date).getTime()+")"),oArgs={},oArgs.secure=!0,oArgs.xmllang=XML_LANG,oArgs.resource=a,oArgs.domain=t,r&&JappixDataStore.setDB(MINI_HASH,"jappix-mini","resource",a),MINI_ANONYMOUS){if(!JappixCommon.allowedAnonymous())return JappixConsole.warn("Not allowed to use anonymous mode."),e.notifyError(),!1;if(JappixCommon.lockHost()&&t!=HOST_ANONYMOUS)return JappixConsole.warn("Not allowed to connect to this anonymous domain: "+t),e.notifyError(),!1;oArgs.authtype="saslanon"}else{if(JappixCommon.lockHost()&&t!=HOST_MAIN)return JappixConsole.warn("Not allowed to connect to this main domain: "+t),e.notifyError(),!1;MINI_NICKNAME||(MINI_NICKNAME=i),oArgs.username=i,oArgs.pass=n}con.connect(oArgs),JappixConsole.info("Jappix Mini is connecting...")}catch(o){JappixConsole.error("JappixMini.connect",o),e.disconnected()}finally{return!1}},e.connected=function(){try{MINI_RECONNECT?(e.reconnected(),JappixConsole.info("Jappix Mini is now reconnected.")):(jQuery("#jappix_mini a.jm_pane.jm_button span.jm_counter").text("0"),MINI_ANONYMOUS?e.initialize():e.getRoster(),JappixConsole.info("Jappix Mini is now connected.")),MINI_RECONNECT=0,JappixDataStore.removeDB(MINI_HASH,"jappix-mini","reconnect"),e.dequeue()}catch(t){JappixConsole.error("JappixMini.connected",t)}},e.reconnected=function(){try{var t=JappixDataStore.getDB(MINI_HASH,"jappix-mini","presence-last")||"available";e.flushStorage("presence"),jQuery("#jappix_mini div.jm_conversation.jm_type_groupchat div.jm_received-messages div.jm_group").remove(),jQuery('#jappix_mini div.jm_status_picker a[data-status="'+JappixCommon.encodeQuotes(t)+'"]').click()}catch(i){JappixConsole.error("JappixMini.reconnected",i)}},e.saveSession=function(){try{if(!MINI_INITIALIZED)return;e.resetPixStream(),JappixDataStore.setDB(MINI_HASH,"jappix-mini","dom",jQuery("#jappix_mini").html()),JappixDataStore.setDB(MINI_HASH,"jappix-mini","nickname",MINI_NICKNAME);var t="",i=jQuery("#jappix_mini div.jm_conversation:has(a.jm_pane.jm_clicked)").attr("data-hash");i&&(t=document.getElementById("received-"+i).scrollTop+""),JappixDataStore.setDB(MINI_HASH,"jappix-mini","scroll",t),JappixCommon.isConnected()?con.suspend(!1):(JappixDataStore.setDB(MINI_HASH,"jappix-mini","reconnect",0===MINI_RECONNECT?0:MINI_RECONNECT-1),e.serializeQueue()),JappixConsole.info("Jappix Mini session save tool launched.")}catch(n){JappixConsole.error("JappixMini.saveSession",n)}},e.flushStorage=function(e){try{var t,i,n;for(i=new RegExp("^"+MINI_HASH+"_jappix-mini"+(e?"_"+e:"")),t=0;t<JappixDataStore.storageDB.length;t++)n=JappixDataStore.storageDB.key(t),i.exec(n)&&JappixDataStore.storageDB.removeItem(n);JappixConsole.log("Jappix Mini DB has been successfully flushed ("+(e?"partly":"completely")+").")}catch(r){JappixConsole.error("JappixMini.flushStorage",r)}},e.disconnect=function(){try{return JappixCommon.isConnected()?(JappixConsole.info("Jappix Mini is disconnecting..."),MINI_DISCONNECT=!0,MINI_INITIALIZED=!1,e.flushStorage(),con.registerHandler("ondisconnect",function(){e.disconnected()}),con.disconnect(),!1):!1}catch(t){JappixConsole.error("JappixMini.disconnect",t)}},e.disconnected=function(){try{!MINI_DISCONNECT||MINI_INITIALIZED?(jQuery("#jappix_mini").stopTime(),MINI_INITIALIZED&&MINI_RECONNECT++<MINI_RECONNECT_MAX?(jQuery("#jappix_mini").oneTime(1e3*MINI_RECONNECT_INTERVAL,function(){JappixConsole.debug("Trying to reconnect... (attempt: "+MINI_RECONNECT+" / "+MINI_RECONNECT_MAX+")"),e.connect(MINI_DOMAIN,MINI_USER,MINI_PASSWORD)}),JappixConsole.info("Jappix Mini is encountering connectivity issues.")):(e.flushStorage(),e.notifyError(),MINI_DISCONNECT=!1,MINI_INITIALIZED=!1,JappixConsole.info("Jappix Mini is giving up. Server seems to be down."))):(launchMini(!1,MINI_SHOWPANE,MINI_DOMAIN,MINI_USER,MINI_PASSWORD),MINI_DISCONNECT=!1,MINI_INITIALIZED=!1,JappixConsole.info("Jappix Mini is now disconnected."))}catch(t){JappixConsole.error("JappixMini.disconnected",t)}},e.handleError=function(t){try{jQuery(t).is("error")&&(e.disconnected(),JappixConsole.error("First level error received."))}catch(i){JappixConsole.error("JappixMini.handleError",i)}},e.handleMessage=function(t){try{var i=t.getType();if("chat"==i||"normal"==i||"groupchat"==i||!i){var n=t.getNode(),r=jQuery.trim(t.getSubject()),a=r?r:jQuery.trim(t.getBody()),o=JappixCommon.fullXID(JappixCommon.getStanzaFrom(t)),s=JappixCommon.bareXID(o),c=hex_md5(s);if(a){var p,l=s,u=JappixCommon.thisResource(o),h=JappixDateUtils.readMessageDelay(n);h?(time=JappixDateUtils.relative(h),p=Date.jab2date(h)):(time=JappixDateUtils.getCompleteTime(),p=new Date);var m=JappixDateUtils.extractStamp(p);JappixCommon.exists("#jappix_mini #chat-"+c+'[data-type="groupchat"]')&&("chat"!=i&&"normal"!=i&&i?l=o:(s=o,c=hex_md5(s)));var d="user-message";if("groupchat"==i)(t.getChild("delay",NS_URN_DELAY)||t.getChild("x",NS_DELAY))&&(d="old-message"),(!u||r)&&(u="",d="system-message");else if(u=jQuery("#jappix_mini a#friend-"+c).text().revertHtmlEnc(),!u){var _=jQuery('#jappix_mini a.jm_unknown[data-xid="'+s+'"]');if(_.size()>0)u=_.attr("data-nick");else{var g=t.getNick();u=JappixCommon.getXIDNick(s),g&&u!=g&&(u=g+" ("+u+")"),_=jQuery('<a class="jm_unknown jm_offline" href="#"></a>').attr("data-nick",u).attr("data-xid",s),_.appendTo("#jappix_mini div.jm_roster div.jm_buddies")}}var f="#jappix_mini #chat-"+c;JappixCommon.exists(f)||"groupchat"==i||e.chat(i,s,u,c),e.displayMessage(i,a,l,u,c,time,m,d),jQuery(f+" a.jm_chat-tab").hasClass("jm_clicked")&&JappixCommon.isFocused()&&MINI_ACTIVE==c||"user-message"!=d||("groupchat"!=i&&e.soundPlay(),e.notifyMessage(c)),JappixConsole.log("Message received from: "+o)}JappixCommon.exists("#jappix_mini #chat-"+c+'[data-type="groupchat"]')&&(s=o,c=hex_md5(s)),e.resetChatstate(s,c,i),(jQuery(n).find('active[xmlns="'+NS_CHATSTATES+'"]').size()||jQuery(n).find('composing[xmlns="'+NS_CHATSTATES+'"]').size())&&(jQuery("#jappix_mini #chat-"+c+" input.jm_send-messages").attr("data-chatstates","true"),jQuery(n).find('composing[xmlns="'+NS_CHATSTATES+'"]').size()&&e.displayChatstate("composing",s,c,i))}}catch(S){JappixConsole.error("JappixMini.handleMessage",S)}},e.handleIQ=function(t){try{var i,n=JappixCommon.fullXID(JappixCommon.getStanzaFrom(t)),r=t.getID(),a=t.getQueryXMLNS(),o=t.getType(),s=t.getNode(),c=new JSJaCIQ;if(c.setID(r),c.setTo(n),c.setType("result"),a==NS_VERSION&&"get"==o)i=c.setQuery(NS_VERSION),i.appendChild(t.buildNode("name",{xmlns:NS_VERSION},"Jappix Mini")),i.appendChild(t.buildNode("version",{xmlns:NS_VERSION},JAPPIX_VERSION)),i.appendChild(t.buildNode("os",{xmlns:NS_VERSION},navigator.platform)),con.send(c),JappixConsole.log("Received software version query: "+n);else if(a==NS_ROSTER&&"set"==o)e.handleRoster(t),con.send(c),JappixConsole.log("Received a roster push.");else if(a==NS_DISCO_INFO&&"get"==o){i=c.setQuery(NS_DISCO_INFO),i.appendChild(t.appendNode("identity",{category:"client",type:"web",name:"Jappix Mini",xmlns:NS_DISCO_INFO}));var p=[NS_DISCO_INFO,NS_VERSION,NS_ROSTER,NS_MUC,NS_VERSION,NS_URN_TIME];for(var l in p)i.appendChild(t.buildNode("feature",{"var":p[l],xmlns:NS_DISCO_INFO}));con.send(c),JappixConsole.log("Received a disco#infos query.")}else if(jQuery(s).find("time").size()&&"get"==o){var u=c.appendNode("time",{xmlns:NS_URN_TIME});u.appendChild(t.buildNode("tzo",{xmlns:NS_URN_TIME},JappixDateUtils.getTZO())),u.appendChild(t.buildNode("utc",{xmlns:NS_URN_TIME},JappixDateUtils.getXMPPTime("utc"))),con.send(c),JappixConsole.log("Received local time query: "+n)}else if(jQuery(s).find("ping").size()&&"get"==o)con.send(c),JappixConsole.log("Received a ping: "+n);else if(!jQuery(s).find("error").size()&&("get"==o||"set"==o)){for(var h=0;h<s.childNodes.length;h++)c.getNode().appendChild(s.childNodes.item(h).cloneNode(!0));var m=c.appendNode("error",{xmlns:NS_CLIENT,code:"501",type:"cancel"});m.appendChild(t.buildNode("feature-not-implemented",{xmlns:NS_STANZAS})),m.appendChild(t.buildNode("text",{xmlns:NS_STANZAS},JappixCommon._e("The feature requested is not implemented by the recipient or server and therefore cannot be processed."))),con.send(c),JappixConsole.log("Received an unsupported IQ query from: "+n)}}catch(d){JappixConsole.error("JappixMini.handleIQ",d)}},e.handlePresence=function(t){try{var i=(t.getNode(),JappixCommon.fullXID(JappixCommon.getStanzaFrom(t))),n=JappixCommon.bareXID(i),r=JappixCommon.thisResource(i),a={};JappixCommon.exists('#jappix_mini div.jm_conversation[data-type="groupchat"][data-xid="'+JappixCommon.escapeQuotes(n)+'"]')&&(n=i),JappixDataStore.setDB(MINI_HASH,"jappix-mini","presence-stanza-"+i,t.xml()),a=e.addResourcePresence(n,r),e.processPresence(n,r,a),e.displayPresence(n),JappixConsole.log("Presence received from: "+i)}catch(o){JappixConsole.error("JappixMini.handlePresence",o)}},e.readPresence=function(e){try{var t=JappixDataStore.getDB(MINI_HASH,"jappix-mini","presence-stanza-"+e);return t||(t='<presence type="unavailable"></presence>'),JappixCommon.XMLFromString(t)}catch(i){JappixConsole.error("JappixMini.readPresence",i)}},e.resourcesPresence=function(e){var t={};try{var i=JappixDataStore.getDB(MINI_HASH,"jappix-mini","presence-resources-"+e);i&&(t=jQuery.evalJSON(i))}catch(n){JappixConsole.error("JappixMini.resourcesPresence",n)}finally{return t}},e.addResourcePresence=function(t,i){try{var n=e.resourcesPresence(t);return n[i]=1,JappixDataStore.setDB(MINI_HASH,"jappix-mini","presence-resources-"+t,jQuery.toJSON(n)),n}catch(r){return JappixConsole.error("JappixMini.addResourcePresence",r),null}},e.removeResourcePresence=function(t,i){try{var n=e.resourcesPresence(t);return delete n[i],JappixDataStore.setDB(MINI_HASH,"jappix-mini","presence-resources-"+t,jQuery.toJSON(n)),n}catch(r){return JappixConsole.error("JappixMini.removeResourcePresence",r),null}},e.processPresence=function(t,i,n){try{if(!t)return void JappixConsole.warn("No XID value for precense processing.");var r,a,o,s,c,p;if(p=null,max_priority=null,-1!==t.indexOf("/"))p=t,JappixConsole.log("Processed presence for groupchat user: "+t);else if(e.priorityPresence(t)){for(r in n)a=t+"/"+r,o=JappixDataStore.getDB(MINI_HASH,"jappix-mini","presence-stanza-"+a),o&&(s=JappixCommon.XMLFromString(o),c=jQuery(s).find("priority").text(),c=isNaN(c)?0:parseInt(c),(c>=max_priority||null===max_priority)&&(max_priority=c,p=a));JappixConsole.log("Processed presence for regular user: "+t+" (highest priority for: "+(p||"none")+")")}else p=t+"/"+i,JappixConsole.log("Processed initial presence for regular user: "+t+" (highest priority for: "+(p||"none")+")");p?JappixDataStore.setDB(MINI_HASH,"jappix-mini","presence-priority-"+t,p):JappixDataStore.removeDB(MINI_HASH,"jappix-mini","presence-priority-"+t)}catch(l){JappixConsole.error("JappixMini.processPresence",l)}},e.priorityPresence=function(e){try{return JappixDataStore.getDB(MINI_HASH,"jappix-mini","presence-priority-"+e)||""}catch(t){return JappixConsole.error("JappixMini.priorityPresence",t),null}},e.displayPresence=function(t){try{var i=e.priorityPresence(t),n=e.readPresence(i),r=jQuery(n).find("presence"),a=JappixCommon.thisResource(i),o=JappixCommon.bareXID(t),s=hex_md5(o),c=r.attr("type"),p=r.find("show").text();if("error"==c||"unavailable"==c)p="unavailable";else switch(p){case"chat":case"away":case"xa":case"dnd":break;default:p="available"}var l="#jappix_mini #chat-"+s+'[data-type="groupchat"]',u=!1;if(JappixCommon.exists(l)&&(u=!0,a!=JappixCommon.unescapeQuotes(jQuery(l).attr("data-nick")))){var h=t,m=s;t=i,s=hex_md5(t);var d;"unavailable"==p?(e.removeBuddy(s,h),d=JappixCommon.printf(JappixCommon._e("%s left"),a.htmlEnc())):(e.addBuddy(t,s,a,h),d=JappixCommon.printf(JappixCommon._e("%s joined"),a.htmlEnc())),MINI_GROUPCHAT_PRESENCE&&d&&"true"==jQuery(l).attr("data-init")&&e.displayMessage("groupchat",d,t,"",m,JappixDateUtils.getCompleteTime(),JappixDateUtils.getTimeStamp(),"system-message")}var _="#jappix_mini #chat-"+s,g="#jappix_mini a#friend-"+s,f=_+" input.jm_send-messages";if("unavailable"==p)jQuery(g).addClass("jm_offline").removeClass("jm_online jm_hover"),jQuery(g).hide(),u&&(jQuery(_).addClass("jm_disabled").attr("data-init","false"),jQuery(f).blur().attr("disabled",!0).attr("data-value",JappixCommon._e("Unavailable")).val(JappixCommon._e("Unavailable")));else{jQuery(g).removeClass("jm_offline").addClass("jm_online");var S=jQuery("#jappix_mini div.jm_roster div.jm_search input.jm_searchbox").val(),C=new RegExp("((^)|( ))"+JappixCommon.escapeRegex(S),"gi"),y=JappixCommon.unescapeQuotes(jQuery(g).data("nick"));S&&!y.match(C)?jQuery(g).hide():jQuery(g).show(),u&&(jQuery(_).removeClass("jm_disabled"),jQuery(f).removeAttr("disabled").val(""))}jQuery(g+" span.jm_presence, "+_+" span.jm_presence").attr("class","jm_presence jm_images jm_"+p),e.updateRoster(),e.updateGroups(),JappixConsole.log("Presence displayed for user: "+t)}catch(v){JappixConsole.error("JappixMini.displayPresence",v)}},e.handleMUC=function(t){try{var i=t.getNode(),n=JappixCommon.fullXID(JappixCommon.getStanzaFrom(t)),r=JappixCommon.bareXID(n),a=hex_md5(r),o=JappixCommon.thisResource(n),s=!1;if(o&&o!=JappixCommon.unescapeQuotes(jQuery("#jappix_mini #chat-"+a+'[data-type="groupchat"]').attr("data-nick"))||(s=!0),s&&jQuery(i).find('error[type="auth"] not-authorized').size())return e.openPrompt(JappixCommon.printf(JappixCommon._e("This room (%s) is protected with a password."),r)),void jQuery("#jappix_popup div.jm_prompt form").submit(function(){try{var t=e.closePrompt();t&&(e.presence("","","","",n,t,!0,e.handleMUC),e.switchPane("chat-"+a,a))}catch(i){}finally{return!1}});if(s&&jQuery(i).find('error[type="cancel"] conflict').size()){var c=o+"_";e.presence("","","","",r+"/"+c,"",!0,e.handleMUC),jQuery("#jappix_mini #chat-"+a).attr("data-nick",JappixCommon.escapeQuotes(c))}else jQuery("#jappix_mini #chat-"+a).oneTime("10s",function(){jQuery(this).attr("data-init","true")}),e.handlePresence(t)}catch(p){JappixConsole.error("JappixMini.handleMUC",p)}},e.presence=function(e,t,i,n,r,a,o,s){try{var c=new JSJaCPresence;if(r&&c.setTo(r),e&&c.setType(e),t&&c.setShow(t),n&&c.setStatus(n),i?c.setPriority(i):MINI_PRIORITY&&!r&&c.setPriority(MINI_PRIORITY),a||o){var p=c.appendNode("x",{xmlns:NS_MUC});a&&p.appendChild(c.buildNode("password",{xmlns:NS_MUC},a)),o&&p.appendChild(c.buildNode("history",{maxstanzas:10,seconds:86400,xmlns:NS_MUC}))}s?con.send(c,s):con.send(c),JappixConsole.info("Presence sent (to: "+(r||"none")+", show: "+(t||"none")+", type: "+(e||"none")+")")}catch(l){JappixConsole.error("JappixMini.presence",l)}},e.sendMessage=function(t){try{var i=jQuery.trim(t.body.value),n=t.xid.value,r=t.type.value,a=hex_md5(n);if(i&&n){var o=new JSJaCMessage,s=jQuery('#jappix_mini a.jm_friend[data-xid="'+JappixCommon.escapeQuotes(n)+'"]');if(0===s.size()){var c=s.attr("data-sub");"both"!=c&&"from"!=c&&o.setNick(MINI_NICKNAME)}o.setTo(n),o.setType(r),o.setBody(i),o.appendNode("active",{xmlns:NS_CHATSTATES}),e.enqueue(o),t.body.value="","groupchat"!=r&&e.displayMessage(r,i,JappixCommon.getXID(),"me",a,JappixDateUtils.getCompleteTime(),JappixDateUtils.getTimeStamp(),"user-message"),JappixConsole.log("Message ("+r+") sent to: "+n)}}catch(p){JappixConsole.error("JappixMini.sendMessage",p)}finally{return!1}},e.enqueue=function(e){try{JappixCommon.isConnected()?con.send(e):(MINI_QUEUE.push(e.xml()),JappixConsole.log("Enqueued an event (to be sent when connectivity is back)."))}catch(t){JappixConsole.error("JappixMini.enqueue",t)}},e.dequeue=function(){try{for(var e,t,i;MINI_QUEUE.length;)e=MINI_QUEUE.shift(),t=JappixCommon.XMLFromString(e).childNodes,t&&t[0]&&(i=JSJaCPacket.wrapNode(t[0]),con.send(i)),JappixConsole.log("Dequeued a stanza.")}catch(n){JappixConsole.error("JappixMini.dequeue",n)}},e.serializeQueue=function(){try{JappixDataStore.setDB(MINI_HASH,"jappix-mini","queue",jQuery.toJSON(MINI_QUEUE))}catch(e){JappixConsole.error("JappixMini.serializeQueue",e)}},e.unserializeQueue=function(){try{var e=JappixDataStore.getDB(MINI_HASH,"jappix-mini","queue");JappixDataStore.removeDB(MINI_HASH,"jappix-mini","queue"),e&&(MINI_QUEUE=jQuery.evalJSON(e))}catch(t){JappixConsole.error("JappixMini.unserialize",t)}},e.smiley=function(e,t){try{return' <img class="jm_smiley jm_smiley-'+e+' jm_images" alt="'+JappixCommon.encodeQuotes(t)+'" src="'+JAPPIX_STATIC+'images/others/blank.gif" /> '}catch(i){return JappixConsole.error("JappixMini.smiley",i),null}},e.notifyMessage=function(t){try{var i="#jappix_mini #chat-"+t+" a.jm_chat-tab",n=i+" span.jm_notify",r=n+" span.jm_notify_middle";JappixCommon.exists(n)||jQuery(i).append('<span class="jm_notify"><span class="jm_notify_left jm_images"></span><span class="jm_notify_middle">0</span><span class="jm_notify_right jm_images"></span></span>');var a=parseInt(jQuery(r).text());jQuery(r).text(a+1),e.notifyCounters()}catch(o){JappixConsole.error("JappixMini.notifyMessage",o)}},e.notifyError=function(){try{jQuery("#jappix_mini").html('<div class="jm_starter"><a class="jm_pane jm_button jm_images" href="'+MINI_ERROR_LINK+'" target="_blank" title="'+JappixCommon._e("Click here to solve the error")+'"><span class="jm_counter jm_error jm_images">'+JappixCommon._e("Error")+"</span></a></div>")}catch(e){JappixConsole.error("JappixMini.notifyError",e)}},e.notifyCounters=function(){try{var e=0;if(jQuery("#jappix_mini span.jm_notify span.jm_notify_middle").each(function(){e+=parseInt(jQuery(this).text())}),jQuery("#jappix_mini a.jm_switch").removeClass("jm_notifnav"),e&&(jQuery("#jappix_mini div.jm_conversation:visible:first").prevAll().find("span.jm_notify").size()&&jQuery("#jappix_mini a.jm_switch.jm_left").addClass("jm_notifnav"),jQuery("#jappix_mini div.jm_conversation:visible:last").nextAll().find("span.jm_notify").size()&&jQuery("#jappix_mini a.jm_switch.jm_right").addClass("jm_notifnav")),null===MINI_TITLE)return;var t=MINI_TITLE;e&&(t="["+e+"] "+t),document.title=t}catch(i){JappixConsole.error("JappixMini.notifyCounters",i)}},e.clearNotifications=function(t){try{return JappixCommon.isFocused()?(jQuery("#jappix_mini #chat-"+t+" span.jm_notify").remove(),e.notifyCounters(),!0):!1}catch(i){return JappixConsole.error("JappixMini.clearNotifications",i),!1}},e.updateRoster=function(){try{jQuery("#jappix_mini a.jm_button span.jm_counter").text(jQuery("#jappix_mini a.jm_online").size())}catch(e){JappixConsole.error("JappixMini.updateRoster",e)}},e.updateGroups=function(){try{jQuery(".jm_grouped_roster").filter(":not(:has(.jm_friend.jm_online:visible))").hide()}catch(e){JappixConsole.error("JappixMini.updateGroups",e)}},e.updateOverflow=function(){try{var t=parseInt((jQuery(window).width()-380)/140),i=jQuery("#jappix_mini div.jm_conversation:visible").size();if(0>=t&&(t=1),t!=i){jQuery("#jappix_mini div.jm_conversation:hidden").show();var n=jQuery("#jappix_mini div.jm_conversation").size();if(n>t){jQuery("#jappix_mini a.jm_switch").size()||(jQuery("#jappix_mini div.jm_conversations").before('<a class="jm_switch jm_left jm_pane jm_images" href="#"><span class="jm_navigation jm_images"></span></a>'),jQuery("#jappix_mini div.jm_conversations").after('<a class="jm_switch jm_right jm_pane jm_images" href="#"><span class="jm_navigation jm_images"></span></a>'),e.overflowEvents());var r=jQuery("#jappix_mini div.jm_conversation:visible:first").index(),a=t-r-1;jQuery("#jappix_mini div.jm_conversation:visible:gt("+a+")").hide(),jQuery("#jappix_mini div.jm_conversation:hidden a.jm_pane.jm_clicked").size()&&e.switchPane(),jQuery("#jappix_mini a.jm_switch").removeClass("jm_nonav"),jQuery("#jappix_mini div.jm_conversation:visible:first").prev().size()||jQuery("#jappix_mini a.jm_switch.jm_left").addClass("jm_nonav"),jQuery("#jappix_mini div.jm_conversation:visible:last").next().size()||jQuery("#jappix_mini a.jm_switch.jm_right").addClass("jm_nonav")}else jQuery("#jappix_mini a.jm_switch").remove(),jQuery("#jappix_mini div.jm_conversation:hidden").show()}}catch(o){JappixConsole.error("JappixMini.updateOverflow",o)}},e.overflowEvents=function(){try{jQuery("#jappix_mini a.jm_switch").click(function(){var t=jQuery(this);if(t.hasClass("jm_nonav"))return!1;var i="",n="";return t.is(".jm_left")?(n=jQuery("#jappix_mini div.jm_conversation:visible:first").prev(),n.size()&&(i=jQuery("#jappix_mini div.jm_conversation:visible:last"))):(n=jQuery("#jappix_mini div.jm_conversation:visible:last").next(),n.size()&&(i=jQuery("#jappix_mini div.jm_conversation:visible:first"))),n&&n.size()&&(i&&i.size()&&(i.hide(),i.find("a.jm_pane").hasClass("jm_clicked")&&e.switchPane()),n.show(),jQuery("#jappix_mini a.jm_switch").removeClass("jm_nonav"),(t.is(".jm_right")&&!n.next().size()||t.is(".jm_left")&&!n.prev().size())&&t.addClass("jm_nonav"),e.notifyCounters()),!1})}catch(t){JappixConsole.error("JappixMini.overflowEvents",t)}},e.create=function(t,i,n){try{var r=JappixDataStore.getDB(MINI_HASH,"jappix-mini","dom"),a=!1,o=!1;if(JappixDataStore.removeDB(MINI_HASH,"jappix-mini","dom"),r&&isNaN(jQuery(r).find("a.jm_pane.jm_button span.jm_counter").text())&&(r=null),r?(con=new JSJaCHttpBindingConnection,e.setupCon(con),o=con.resume(),MINI_NICKNAME=JappixDataStore.getDB(MINI_HASH,"jappix-mini","nickname"),a=!0,MINI_ROSTER_INIT=!0):r='<div class="jm_position"><div class="jm_conversations"></div><div class="jm_starter"><div class="jm_roster"><div class="jm_actions"><a class="jm_logo jm_images" href="https://mini.jappix.com/" target="_blank"></a><a class="jm_one-action jm_join jm_images" title="'+JappixCommon._e("Join a chat")+'" href="#"></a><a class="jm_one-action jm_status" title="'+JappixCommon._e("Status")+'" href="#"><span class="jm_presence jm_images jm_available"></span></a><div class="jm_status_picker"><a href="#" data-status="available"><span class="jm_presence jm_images jm_available"></span><span class="jm_show_text">'+JappixCommon._e("Available")+'</span></a><a href="#" data-status="away"><span class="jm_presence jm_images jm_away"></span><span class="jm_show_text">'+JappixCommon._e("Away")+'</span></a><a href="#" data-status="dnd"><span class="jm_presence jm_images jm_dnd"></span><span class="jm_show_text">'+JappixCommon._e("Busy")+'</span></a><a href="#" data-status="unavailable"><span class="jm_presence jm_images jm_unavailable"></span><span class="jm_show_text">'+JappixCommon._e("Offline")+'</span></a></div></div><div class="jm_buddies"></div><div class="jm_search"><input type="text" class="jm_searchbox jm_images" placeholder="'+JappixCommon._e("Filter")+'" data-value="" /></div></div><a class="jm_pane jm_button jm_images" href="#"><span class="jm_counter jm_images">'+JappixCommon._e("Please wait...")+"</span></a></div></div>",jQuery("body").append('<div id="jappix_mini" style="display: none;" dir="'+(JappixCommon.isRTL()?"rtl":"ltr")+'">'+r+"</div>"),jQuery("#jappix_mini a.jm_status.active, #jappix_mini a.jm_join.active").removeClass("active"),jQuery("#jappix_mini div.jm_status_picker").hide(),jQuery("#jappix_mini div.jm_chan_suggest").remove(),e.overflowEvents(),jQuery("#jappix_mini").everyTime(100,function(){var t=jQuery(this);t.is(":visible")&&(JappixConsole.info("CSS loaded asynchronously."),t.stopTime(),e.updateOverflow(),e.adaptRoster(),e.updatePixStream())}),"on"===ADS_ENABLE&&GADS_CLIENT&&GADS_SLOT&&jQuery("#jappix_mini div.jm_conversations").everyTime("60s",function(){JappixConsole.debug("JappixMini.create[timer]","Auto-updating ads..."),e.updatePixStream(),JappixConsole.debug("JappixMini.create[timer]","Done auto-updating ads.")}),jQuery("#jappix_mini div.jm_starter").css("float","right"),jQuery("#jappix_mini div.jm_conversations, #jappix_mini div.jm_conversation, #jappix_mini a.jm_switch").css("float","left"),jQuery("#jappix_mini a.jm_button").click(function(){try{var r="#jappix_mini a.jm_pane.jm_button span.jm_counter";if(jQuery(r).text()==JappixCommon._e("Please wait..."))return!1;if(jQuery(r).text()==JappixCommon._e("Chat"))return jQuery("#jappix_mini div.jm_starter span.jm_animate").remove(),jQuery(r).text(JappixCommon._e("Please wait...")),e.connect(t,i,n),!1;jQuery(this).hasClass("jm_clicked")?e.hideRoster():e.showRoster()}catch(a){}finally{return!1}}),jQuery("#jappix_mini a.jm_status").click(function(){try{var e=jQuery(this),t=e.hasClass("active");jQuery("#jappix_mini div.jm_actions a").blur().removeClass("active"),t?jQuery("#jappix_mini div.jm_status_picker").hide():(jQuery("#jappix_mini div.jm_chan_suggest").remove(),jQuery("#jappix_mini div.jm_status_picker").show(),e.addClass("active"))}catch(i){}finally{return!1}}),jQuery("#jappix_mini div.jm_status_picker a").click(function(){try{var t=jQuery(this),i=[""];jQuery('#jappix_mini div.jm_conversation[data-type="groupchat"]').each(function(){var e=jQuery(this);i.push(JappixCommon.unescapeQuotes(e.attr("data-xid"))+"/"+JappixCommon.unescapeQuotes(e.attr("data-nick")))});var n=t.data("status");jQuery.each(i,function(t,i){switch(n){case"available":e.presence("","","","",i);break;case"away":e.presence("","away","","",i);break;case"dnd":e.presence("","dnd","","",i);break;case"unavailable":e.disconnect();break;default:e.presence("","","","",i)}}),"unavailable"!=n&&(jQuery("#jappix_mini a.jm_status span").removeClass("jm_available jm_away jm_dnd jm_unavailable").addClass("jm_"+t.data("status")),jQuery("#jappix_mini div.jm_status_picker").hide(),jQuery("#jappix_mini a.jm_status").blur().removeClass("active"))}catch(r){}finally{return!1}}),jQuery("#jappix_mini div.jm_actions a.jm_join").click(function(){try{var t=jQuery(this);if(MINI_SUGGEST_CHATS&&MINI_SUGGEST_CHATS.length||MINI_SUGGEST_GROUPCHATS&&MINI_SUGGEST_GROUPCHATS.length){var i=t.hasClass("active");if(jQuery("#jappix_mini div.jm_actions a").blur().removeClass("active"),i)jQuery("#jappix_mini div.jm_chan_suggest").remove();else{jQuery("#jappix_mini div.jm_status_picker").hide(),t.addClass("active");for(var n="",r=0;r<MINI_SUGGEST_GROUPCHATS.length;r++)if(MINI_SUGGEST_GROUPCHATS[r])try{var a=JappixCommon.bareXID(JappixCommon.generateXID(MINI_SUGGEST_GROUPCHATS[r],"groupchat")),o=MINI_SUGGEST_PASSWORDS[r]||"";n+='<a class="jm_suggest_groupchat" href="#" data-xid="'+JappixCommon.escapeQuotes(a)+'" data-pwd="'+JappixCommon.escapeQuotes(o)+'"><span class="jm_chan_icon jm_images"></span><span class="jm_chan_name">'+JappixCommon.getXIDNick(a).htmlEnc()+"</span></a>"}catch(s){}n&&(n+='<div class="jm_space"></div>');for(var c=0;c<MINI_SUGGEST_CHATS.length;c++)if(MINI_SUGGEST_CHATS[c])try{var p=JappixCommon.bareXID(JappixCommon.generateXID(MINI_SUGGEST_CHATS[c],"chat")),l=hex_md5(p),u=jQuery("#jappix_mini a#friend-"+l).attr("data-nick");u=u?JappixCommon.unescapeQuotes(u):JappixCommon.getXIDNick(p),n+='<a class="jm_suggest_chat" href="#" data-xid="'+JappixCommon.escapeQuotes(p)+'"><span class="jm_chan_icon jm_images"></span><span class="jm_chan_name">'+JappixCommon.getXIDNick(u).htmlEnc()+"</span></a>"}catch(s){}n&&(n+='<div class="jm_space"></div>'),jQuery("#jappix_mini div.jm_actions").append('<div class="jm_chan_suggest">'+n+'<a class="jm_suggest_prompt" href="#"><span class="jm_chan_icon"></span><span class="jm_chan_name">'+JappixCommon._e("Other")+"</span></a></div>"),jQuery("#jappix_mini div.jm_chan_suggest a").click(function(){try{var t=jQuery(this);if(t.is(".jm_suggest_chat")){var i=JappixCommon.unescapeQuotes(t.attr("data-xid"));e.chat("chat",i,t.find("span.jm_chan_name").text(),hex_md5(i))}else if(t.is(".jm_suggest_groupchat")){var n=JappixCommon.unescapeQuotes(t.attr("data-xid")),r=t.attr("data-pwd")||null;r&&(r=JappixCommon.unescapeQuotes(r)),e.chat("groupchat",n,t.find("span.jm_chan_name").text(),hex_md5(n),r)}else e.groupchatPrompt()}catch(a){}finally{return!1}}),e.adaptRoster()}}else e.groupchatPrompt()}catch(s){}finally{return!1}}),jQuery("#jappix_mini div.jm_roster div.jm_search input.jm_searchbox").keyup(function(t){var i=jQuery(this);if(38!=t.keyCode&&40!=t.keyCode){27==t.keyCode&&i.val(""),i.attr("data-value",i.val());var n=this;JappixCommon.typewatch()(function(){try{var t=jQuery(n).val(),i=new RegExp("((^)|( ))"+JappixCommon.escapeRegex(t),"gi");if(jQuery("#jappix_mini a.jm_friend.jm_hover").removeClass("jm_hover"),jQuery("#jappix_mini div.jm_roster div.jm_grouped").show(),!t)return jQuery("#jappix_mini div.jm_roster div.jm_buddies a.jm_online").show(),void e.updateGroups();jQuery("#jappix_mini div.jm_roster div.jm_buddies a.jm_online").each(function(){var e=jQuery(this),t=JappixCommon.unescapeQuotes(e.data("nick"));t.match(i)?e.show():e.hide()}),jQuery("#jappix_mini div.jm_roster div.jm_grouped").each(function(){var e=jQuery(this);e.find("a.jm_online:visible").size()||e.hide()}),jQuery("#jappix_mini div.jm_roster div.jm_buddies a.jm_online:visible:first").addClass("jm_hover")}catch(r){}finally{return!1}},500)}}),jQuery(document).keydown(function(e){if(!jQuery("#jappix_mini div.jm_roster").is(":hidden")){if(38==e.keyCode||40==e.keyCode){if(jQuery("#jappix_mini a.jm_online.jm_hover").size()){if(jQuery("#jappix_mini a.jm_online:visible").size()>1){var t=jQuery("#jappix_mini a.jm_online:visible").index(jQuery("a.jm_hover"));
38==e.keyCode?t--:t++,t||(t=0),jQuery("#jappix_mini a.jm_online:visible").eq(t).size()||(t=38==e.keyCode?jQuery("#jappix_mini a.jm_online:visible:last").index():0),jQuery("#jappix_mini a.jm_friend.jm_hover").removeClass("jm_hover"),jQuery("#jappix_mini a.jm_online:visible").eq(t).addClass("jm_hover")}}else 38==e.keyCode?jQuery("#jappix_mini a.jm_online:visible:last").addClass("jm_hover"):jQuery("#jappix_mini a.jm_online:visible:first").addClass("jm_hover");return jQuery("#jappix_mini div.jm_roster div.jm_buddies").scrollTo(jQuery("#jappix_mini a.jm_online.jm_hover"),0,{margin:!0}),!1}return 13==e.keyCode&&jQuery("#jappix_mini a.jm_friend.jm_hover").size()?(jQuery("#jappix_mini a.jm_friend.jm_hover").click(),!1):void 0}}),jQuery(document).keypress(function(e){var t="#jappix_mini div.jm_conversation div.jm_chat-content";if(!jQuery("input, textarea").is(":focus")&&jQuery(t).is(":visible"))try{var i=jQuery.trim(String.fromCharCode(e.which));if(i){var n=t+" input.jm_send-messages";jQuery(document).oneTime(10,function(){select_input=jQuery(n),value_input=select_input.val(),select_input.val(value_input+i),select_input.focus(),select_input[0].selectionStart=select_input[0].selectionEnd=value_input.length+1})}}catch(r){}}),jQuery(document).click(function(t){jQuery(t.target).parents("#jappix_mini").size()||JappixCommon.exists("#jappix_popup")||e.hideRoster()}),jQuery(document).dblclick(function(t){jQuery(t.target).parents("#jappix_mini").size()||JappixCommon.exists("#jappix_popup")||e.switchPane()}),a){if(MINI_INITIALIZED=!0,!o){var s=JappixDataStore.getDB(MINI_HASH,"jappix-mini","reconnect");isNaN(s)||(MINI_RECONNECT=parseInt(s)),e.unserializeQueue(),e.disconnected()}jQuery("#jappix_mini div.jm_conversation input.jm_send-messages").each(function(){var e=jQuery(this),t=e.attr("data-value");t&&e.val(t)});var c=jQuery("#jappix_mini div.jm_roster div.jm_search input.jm_searchbox"),p=c.attr("data-value");p&&c.val(p).keyup(),e.eventsBuddy("#jappix_mini a.jm_friend"),jQuery("#jappix_mini div.jm_conversation").each(function(){var t=jQuery(this);e.chatEvents(t.attr("data-type"),JappixCommon.unescapeQuotes(t.attr("data-xid")),t.attr("data-hash"))}),jQuery('#jappix_mini div.jm_conversation[data-type="groupchat"]').attr("data-init","true");var l=jQuery("#jappix_mini div.jm_conversation:has(a.jm_pane.jm_clicked)").attr("data-hash"),u=JappixDataStore.getDB(MINI_HASH,"jappix-mini","scroll");u&&(u=parseInt(u)),l&&jQuery(document).oneTime(200,function(){e.messageScroll(l,u)}),e.notifyCounters()}else MINI_AUTOCONNECT?e.connect(t,i,n):(jQuery("#jappix_mini a.jm_pane.jm_button span.jm_counter").text(JappixCommon._e("Chat")),MINI_ANIMATE&&jQuery("#jappix_mini div.jm_starter").prepend('<span class="jm_animate jm_images_animate"></span>'))}catch(h){JappixConsole.error("JappixMini.create",h)}},e.eventsBuddy=function(t){try{var i=jQuery(t);i.click(function(){try{var t=jQuery(this);e.chat("chat",JappixCommon.unescapeQuotes(t.attr("data-xid")),JappixCommon.unescapeQuotes(t.attr("data-nick")),t.attr("data-hash"))}catch(i){}finally{return!1}}),i.hover(function(){jQuery("#jappix_mini a.jm_friend.jm_hover").removeClass("jm_hover"),jQuery(this).addClass("jm_hover")},function(){jQuery(this).removeClass("jm_hover")}),i.mousedown(function(){jQuery("#jappix_mini a.jm_friend.jm_hover").removeClass("jm_hover"),jQuery(this).addClass("jm_hover")}),i.focus(function(){jQuery("#jappix_mini a.jm_friend.jm_hover").removeClass("jm_hover"),jQuery(this).addClass("jm_hover")}),i.blur(function(){jQuery(this).removeClass("jm_hover")})}catch(n){JappixConsole.error("JappixMini.eventsBuddy",n)}},e.displayMessage=function(t,i,n,r,a,o,s,c){try{var p="#chat-"+a,l=document.getElementById("received-"+a),u=!1;l.scrollTop&&l.clientHeight+l.scrollTop!=l.scrollHeight||(u=!0);var h=jQuery(p+" div.jm_group:last"),m=parseInt(h.attr("data-stamp")),d=jQuery(p+" b:last"),_=d.attr("data-xid"),g=h.attr("data-type"),f=!1,S="";_==n&&c==g&&1800>=s-m?f=!0:(r&&(S+='<span class="jm_date">'+o+"</span>"),S+="groupchat"==t?'<b class="jm_name" style="color: '+JappixCommon.generateColor(r)+';" data-xid="'+JappixCommon.encodeQuotes(n)+'">'+r.htmlEnc()+"</b>":"me"==r?'<b class="jm_name jm_me" data-xid="'+JappixCommon.encodeQuotes(n)+'">'+JappixCommon._e("You")+"</b>":'<b class="jm_name jm_him" data-xid="'+JappixCommon.encodeQuotes(n)+'">'+r.htmlEnc()+"</b>");var C=!1;i.match(/^\/me /i)&&(i=i.replace(/^\/me /i,r+" "),C=!0),i=i.htmlEnc(),i=i.replace(/(;-?\))(\s|$)/gi,e.smiley("wink","$1")).replace(/(:-?3)(\s|$)/gi,e.smiley("waii","$1")).replace(/(:-?\()(\s|$)/gi,e.smiley("unhappy","$1")).replace(/(:-?P)(\s|$)/gi,e.smiley("tongue","$1")).replace(/(:-?O)(\s|$)/gi,e.smiley("surprised","$1")).replace(/(:-?\))(\s|$)/gi,e.smiley("smile","$1")).replace(/(\^_?\^)(\s|$)/gi,e.smiley("happy","$1")).replace(/(:-?D)(\s|$)/gi,e.smiley("grin","$1")),i=i.replace(/(^|\s|>|\()((\*)([^<>'"\*]+)(\*))($|\s|<|\))/gi,"$1<b>$2</b>$6").replace(/(^|\s|>|\()((\/)([^<>'"\/]+)(\/))($|\s|<|\))/gi,"$1<em>$2</em>$6").replace(/(^|\s|>|\()((_)([^<>'"_]+)(_))($|\s|<|\))/gi,'$1<span style="text-decoration: underline;">$2</span>$6'),i=JappixLinks.apply(i,"mini"),C&&(i="<em>"+i+"</em>"),i="<p>"+i+"</p>",f?jQuery("#jappix_mini #chat-"+a+" div.jm_received-messages div.jm_group:last").append(i):jQuery("#jappix_mini #chat-"+a+" div.jm_chatstate_typing").before('<div class="jm_group jm_'+c+'" data-type="'+c+'" data-stamp="'+s+'">'+S+i+"</div>"),u&&e.messageScroll(a)}catch(y){JappixConsole.error("JappixMini.displayMessage",y)}},e.switchPane=function(t,i){try{if(e.hideRoster(),jQuery("#jappix_mini a.jm_pane").removeClass("jm_clicked"),jQuery("#jappix_mini div.jm_chat-content").hide(),t&&"roster"!=t){var n="#jappix_mini #"+t;if(jQuery(n).size()&&jQuery(n).is(":hidden")){var r="";if(r=jQuery("#jappix_mini div.jm_conversation:visible:first").prevAll().is("#"+t)?jQuery("#jappix_mini a.jm_switch.jm_left"):jQuery("#jappix_mini a.jm_switch.jm_right"))for(;jQuery(n).is(":hidden")&&!r.hasClass("jm_nonav");)r.click()}jQuery(n+" a.jm_pane").addClass("jm_clicked"),jQuery(n+" div.jm_chat-content").show(),jQuery(document).oneTime(10,function(){jQuery(n+" input.jm_send-messages").focus()}),i&&(e.messageScroll(i),e.updatePixStream(i))}}catch(a){JappixConsole.error("JappixMini.switchPane",a)}},e.messageScroll=function(e,t){try{var i=document.getElementById("received-"+e);t||(t=i.scrollHeight),i.scrollTop=t}catch(n){JappixConsole.error("JappixMini.messageScroll",n)}},e.openPrompt=function(t,i){try{var n="#jappix_popup div.jm_prompt",r=n+" form input",a=r+'[type="text"]';e.closePrompt(),jQuery("body").append('<div id="jappix_popup" dir="'+(JappixCommon.isRTL()?"rtl":"ltr")+'"><div class="jm_prompt"><form>'+t+'<input class="jm_text" type="text" value="" /><input class="jm_submit" type="submit" value="'+JappixCommon._e("Submit")+'" /><input class="jm_submit" type="reset" value="'+JappixCommon._e("Cancel")+'" /><div class="jm_clear"></div></form></div></div>');var o="-"+(jQuery(n).height()/2+10)+"px";jQuery(n).css("margin-top",o),i&&jQuery(a).val(i),jQuery(document).oneTime(10,function(){jQuery(a).focus()}),jQuery(r+'[type="reset"]').click(function(){try{e.closePrompt()}catch(t){}finally{return!1}})}catch(s){JappixConsole.error("JappixMini.openPrompt",s)}},e.closePrompt=function(){try{var e=jQuery("#jappix_popup div.jm_prompt form input").val();return jQuery("#jappix_popup").remove(),e}catch(t){JappixConsole.error("JappixMini.closePrompt",t)}},e.groupchatPrompt=function(){try{e.openPrompt(JappixCommon._e("Please enter the group chat address to join.")),jQuery("#jappix_popup div.jm_prompt form").submit(function(){try{var t=e.closePrompt();t&&(chat_room=JappixCommon.bareXID(JappixCommon.generateXID(t,"groupchat")),e.chat("groupchat",chat_room,JappixCommon.getXIDNick(chat_room),hex_md5(chat_room)))}catch(i){}finally{return!1}})}catch(t){JappixConsole.error("JappixMini.groupchatPrompt",t)}},e.chat=function(t,i,n,r,a,o){try{var s="#jappix_mini #chat-"+r,c=null;if(!JappixCommon.exists(s)){if("groupchat"==t&&(!MINI_NICKNAME&&MINI_RANDNICK&&(MINI_NICKNAME=e.randomNick()),c=MINI_NICKNAME,!c))return e.openPrompt(JappixCommon.printf(JappixCommon._e("Please enter your nickname to join %s."),i)),void jQuery("#jappix_popup div.jm_prompt form").submit(function(){try{var o=e.closePrompt();o&&(MINI_NICKNAME=o),e.chat(t,i,n,r,a)}catch(s){}finally{return!1}});var p='<div class="jm_conversation jm_type_'+t+'" id="chat-'+r+'" data-xid="'+JappixCommon.escapeQuotes(i)+'" data-type="'+t+'" data-nick="'+JappixCommon.escapeQuotes(n)+'" data-hash="'+r+'" data-origin="'+JappixCommon.escapeQuotes(JappixCommon.cutResource(i))+'"><div class="jm_chat-content"><div class="jm_actions"><span class="jm_nick">'+n+"</span>",l=!1,u=!1;if("groupchat"==t&&MINI_GROUPCHATS&&MINI_GROUPCHATS.length)for(var h in MINI_GROUPCHATS)if(i==JappixCommon.bareXID(JappixCommon.generateXID(MINI_GROUPCHATS[h],"groupchat"))){l=!0;break}if("chat"==t&&MINI_CHATS&&MINI_CHATS.length)for(var m in MINI_CHATS)if(i==JappixCommon.bareXID(JappixCommon.generateXID(MINI_CHATS[m],"chat"))){u=!0;break}if(("groupchat"==t&&!l||"chat"==t&&!u||"groupchat"!=t&&"chat"!=t)&&(p+='<a class="jm_one-action jm_close jm_images" title="'+JappixCommon._e("Close")+'" href="#"></a>'),p+='</div><div class="jm_pix_stream"></div><div class="jm_received-messages" id="received-'+r+'"><div class="jm_chatstate_typing">'+JappixCommon.printf(JappixCommon._e("%s is typing..."),n.htmlEnc())+'</div></div><form action="#" method="post"><input type="text" class="jm_send-messages" name="body" autocomplete="off" placeholder="'+JappixCommon._e("Chat")+'" data-value="" /><input type="hidden" name="xid" value="'+i+'" /><input type="hidden" name="type" value="'+t+'" /></form></div><a class="jm_pane jm_chat-tab jm_images" href="#"><span class="jm_name">'+n.htmlEnc()+"</span></a></div>",jQuery("#jappix_mini div.jm_conversations").prepend(p),"groupchat"!=t){var d=jQuery("#jappix_mini a#friend-"+r+" span.jm_presence"),_="available";d.hasClass("jm_unavailable")||!d.size()?_="unavailable":d.hasClass("jm_chat")?_="chat":d.hasClass("jm_away")?_="away":d.hasClass("jm_xa")?_="xa":d.hasClass("jm_dnd")&&(_="dnd"),jQuery(s+" a.jm_chat-tab").prepend('<span class="jm_presence jm_images jm_'+_+'"></span>')}e.chatEvents(t,i,r),"groupchat"==t&&(jQuery(s).attr("data-nick",JappixCommon.escapeQuotes(c)).attr("data-init","false"),e.presence("","","","",i+"/"+c,a,!0,e.handleMUC))}o!==!1&&jQuery(document).oneTime(10,function(){e.switchPane("chat-"+r,r)}),e.updateOverflow()}catch(g){JappixConsole.error("JappixMini.chat",g)}finally{return!1}},e.chatEvents=function(t,i,n){try{var r=jQuery("#jappix_mini #chat-"+n);r.find("form").submit(function(){return e.sendMessage(this)}),r.find("a.jm_chat-tab").click(function(){try{jQuery(this).hasClass("jm_clicked")?e.switchPane():(e.switchPane("chat-"+n,n),e.clearNotifications(n))}catch(t){}finally{return!1}}),r.find("div.jm_actions").click(function(a){try{jQuery(a.target).is("a.jm_close")?("groupchat"!=t&&e.sendChatstate("gone",i,n),r.stopTime().remove(),"groupchat"==t&&(e.presence("unavailable","","","",i+"/"+JappixCommon.unescapeQuotes(r.attr("data-nick"))),e.removeGroupchat(i)),e.updateOverflow()):r.find("a.jm_chat-tab.jm_clicked").click()}catch(o){}finally{return!1}}),r.find("input.jm_send-messages").focus(function(){e.clearNotifications(n)}).keyup(function(){var e=jQuery(this);e.attr("data-value",e.val())}).keydown(function(t){return 9==t.keyCode?(e.switchChat(),!1):27==t.keyCode?(r.find("a.jm_close").size()&&(r.next("div.jm_conversation").size()?r.next("div.jm_conversation").find("a.jm_pane").click():r.prev("div.jm_conversation").size()&&r.prev("div.jm_conversation").find("a.jm_pane").click(),r.find("a.jm_close").click()),!1):void 0}),jQuery("#jappix_mini #chat-"+n+" input.jm_send-messages").focus(function(){MINI_ACTIVE=n}).blur(function(){MINI_ACTIVE==n&&(MINI_ACTIVE=null)}),e.eventsChatstate(i,n,t)}catch(a){JappixConsole.error("JappixMini.chatEvents",a)}},e.switchChat=function(){try{if(jQuery("#jappix_mini div.jm_conversation").size()<=1)return;var t=jQuery("#jappix_mini div.jm_conversation:has(a.jm_pane.jm_clicked)").index();for(t++,t||(t=0),jQuery("#jappix_mini div.jm_conversation").eq(t).size()||(t=0);jQuery("#jappix_mini div.jm_conversation").eq(t).hasClass("jm_disabled");)t++;var i=jQuery("#jappix_mini div.jm_conversation").eq(t).attr("data-hash");i&&e.switchPane("chat-"+i,i)}catch(n){JappixConsole.error("JappixMini.switchChat",n)}},e.showRoster=function(){try{e.switchPane("roster"),jQuery("#jappix_mini div.jm_roster").show(),jQuery("#jappix_mini a.jm_button").addClass("jm_clicked"),e.updateGroups(),jQuery(document).oneTime(10,function(){jQuery("#jappix_mini div.jm_roster div.jm_search input.jm_searchbox").focus()})}catch(t){JappixConsole.error("JappixMini.showRoster",t)}},e.hideRoster=function(){try{jQuery("#jappix_mini a.jm_status.active, #jappix_mini a.jm_join.active").click(),jQuery("#jappix_mini div.jm_roster").hide(),jQuery("#jappix_mini a.jm_button").removeClass("jm_clicked"),jQuery("#jappix_mini div.jm_roster div.jm_search input.jm_searchbox").val("").attr("data-value",""),jQuery("#jappix_mini div.jm_roster div.jm_grouped").show(),jQuery("#jappix_mini div.jm_roster div.jm_buddies a.jm_online").show(),jQuery("#jappix_mini a.jm_friend.jm_hover").removeClass("jm_hover")}catch(e){JappixConsole.error("JappixMini.hideRoster",e)}},e.removeGroupchat=function(t){try{jQuery('#jappix_mini div.jm_conversation[data-origin="'+JappixCommon.escapeQuotes(JappixCommon.cutResource(t))+'"], #jappix_mini div.jm_roster div.jm_grouped[data-xid="'+JappixCommon.escapeQuotes(t)+'"]').remove(),e.updateRoster()}catch(i){JappixConsole.error("JappixMini.removeGroupchat",i)}},e.initialize=function(){try{MINI_INITIALIZED=!0,e.presence();for(var t=0;t<MINI_GROUPCHATS.length;t++)if(MINI_GROUPCHATS[t])try{var i=JappixCommon.bareXID(JappixCommon.generateXID(MINI_GROUPCHATS[t],"groupchat"));e.chat("groupchat",i,JappixCommon.getXIDNick(i),hex_md5(i),MINI_PASSWORDS[t],MINI_SHOWPANE)}catch(n){}for(var r=0;r<MINI_CHATS.length;r++)if(MINI_CHATS[r])try{var a=JappixCommon.bareXID(JappixCommon.generateXID(MINI_CHATS[r],"chat")),o=hex_md5(a),s=jQuery("#jappix_mini a#friend-"+o).attr("data-nick");s=s?JappixCommon.unescapeQuotes(s):JappixCommon.getXIDNick(a),e.chat("chat",a,s,o)}catch(n){}MINI_AUTOCONNECT||MINI_GROUPCHATS.length||MINI_CHATS.length||jQuery(document).oneTime(10,function(){e.showRoster()})}catch(n){JappixConsole.error("JappixMini.initialize",n)}},e.addListBuddy=function(t){try{var i,n,r="";for(i in t){t[i]=t[i].sort(),i!=MINI_ROSTER_NOGROUP&&(r+='<div class="jm_grouped jm_grouped_roster" data-name="'+JappixCommon.escapeQuotes(i)+'">',r+='<div class="jm_name">'+i.htmlEnc()+"</div>");for(n in t[i])r+=e.codeAddBuddy(t[i][n][0],t[i][n][1],t[i][n][2],t[i][n][3],!1);i!=MINI_ROSTER_NOGROUP&&(r+="</div>")}return jQuery("#jappix_mini div.jm_roster div.jm_buddies").html(r),e.eventsBuddy("#jappix_mini a.jm_friend"),!0}catch(a){return JappixConsole.error("JappixMini.addListBuddy",a),!1}},e.addBuddy=function(t,i,n,r,a,o){try{var s=JappixCommon.bareXID(t),c="#jappix_mini a#friend-"+i;JappixCommon.exists(c)&&jQuery(c).remove();var p="#jappix_mini div.jm_roster div.jm_buddies";r?(p='#jappix_mini div.jm_roster div.jm_grouped_groupchat[data-xid="'+JappixCommon.escapeQuotes(s)+'"]',JappixCommon.exists(p)||jQuery("#jappix_mini div.jm_roster div.jm_buddies").append('<div class="jm_grouped jm_grouped_groupchat" data-xid="'+JappixCommon.escapeQuotes(s)+'"><div class="jm_name">'+JappixCommon.getXIDNick(r).htmlEnc()+"</div></div>")):o&&(p='#jappix_mini div.jm_roster div.jm_grouped_roster[data-name="'+JappixCommon.escapeQuotes(o)+'"]',JappixCommon.exists(p)||jQuery("#jappix_mini div.jm_roster div.jm_buddies").append('<div class="jm_grouped jm_grouped_roster" data-name="'+JappixCommon.escapeQuotes(o)+'"><div class="jm_name">'+o.htmlEnc()+"</div></div>"));var l=e.codeAddBuddy(n,i,t,a);return r||o?jQuery(p).append(l):jQuery(p).prepend(l),jQuery("#jappix_mini div.jm_actions a.jm_toggle_view.jm_toggled").size()&&jQuery(c).filter(".jm_offline").hide(),e.eventsBuddy(c),!0}catch(u){return JappixConsole.error("JappixMini.addBuddy",u),!1}},e.codeAddBuddy=function(e,t,i,n){var r="";try{r+='<a class="jm_friend jm_offline jm_friend-'+t,r+='" id="friend-'+t,r+='" title="'+JappixCommon.encodeQuotes(i)+'"',r+='" data-xid="'+JappixCommon.escapeQuotes(i)+'"',r+='" data-nick="'+JappixCommon.escapeQuotes(e)+'"',r+='" data-hash="'+t+'"',r+=" "+(n?' data-sub="'+n+'" ':""),r+=">",r+='<span class="jm_presence jm_images jm_unavailable"></span>',r+=e.htmlEnc(),r+='<span class="jm_jingle_icon jm_images"></span>',r+="</a>"}catch(a){JappixConsole.error("JappixMini.codeAddBuddy",a)}finally{return r}},e.removeBuddy=function(e,t){try{jQuery("#jappix_mini a#friend-"+e).remove();var i='#jappix_mini div.jm_roster div.jm_grouped_groupchat[data-xid="'+JappixCommon.escapeQuotes(t)+'"]';return t&&!jQuery(i+" a.jm_friend").size()&&jQuery(i).remove(),!0}catch(n){return JappixConsole.error("JappixMini.removeBuddy",n),!1}},e.getRoster=function(){try{var t=new JSJaCIQ;t.setType("get"),t.setQuery(NS_ROSTER),con.send(t,e.handleRoster),JappixConsole.info("Getting roster...")}catch(i){JappixConsole.error("JappixMini.getRoster",i)}},e.handleRoster=function(t){try{var i,n,r,a,o,s,c,p,l,u,h;if(i={},n={},jQuery(t.getQuery()).find("item").each(function(){var e=jQuery(this);if(o=e,s=o.attr("jid"),c=o.attr("subscription"),!JappixCommon.isGateway(s)){p=o.attr("name"),l=hex_md5(s),p||(p=JappixCommon.getXIDNick(s)),r=[],r[0]=p,r[1]=l,r[2]=s,r[3]=c,a={},e.find("group").size()?e.find("group").each(function(){t=jQuery(this).text(),t&&(a[t]=1)}):a[MINI_ROSTER_NOGROUP]=1;for(var t in a)"number"!=typeof n[t]&&(n[t]=0),"object"!=typeof i[t]&&(i[t]=[]),i[t][n[t]++]=r}}),MINI_ROSTER_INIT)for(h in i)for(u=0;u<i[h].length;u++)i[h][u]&&(p=i[h][u][0],l=i[h][u][1],s=i[h][u][2],c=i[h][u][3],"remove"==c?e.removeBuddy(l):e.addBuddy(s,l,p,null,c,h!=MINI_ROSTER_NOGROUP?h:null));else MINI_ROSTER_INIT=!0,e.addListBuddy(i);MINI_INITIALIZED||e.initialize(),JappixConsole.info("Roster got.")}catch(m){JappixConsole.error("JappixMini.handleRoster",m)}},e.adaptRoster=function(){try{var e=jQuery(window).height()-85;jQuery("#jappix_mini div.jm_roster div.jm_buddies").css("max-height",e);var t=jQuery("#jappix_mini div.jm_roster").height()-46;jQuery("#jappix_mini div.jm_chan_suggest").css("max-height",t)}catch(i){JappixConsole.error("JappixMini.adaptRoster",i)}},e.randomNick=function(){try{var e=["Just","Bob","Jar","Pedr","Yod","Maz","Vez","Car","Erw","Tiet","Iot","Wal","Bez","Pop","Klop","Zaz","Yoy","Raz"],t=["io","ice","a","u","o","ou","oi","ana","oro","izi","ozo","aza","ato","ito","ofa","oki","ima","omi"],i=["t","z","r","n","tt","zz","pp","j","k","v","c","x","ti","to","ta","ra","ro","ri"],n=JappixCommon.randomArrayValue(e)+JappixCommon.randomArrayValue(t)+JappixCommon.randomArrayValue(i);return n}catch(r){JappixConsole.error("JappixMini.randomNick",r)}},e.sendChatstate=function(e,t,i){try{var n=jQuery("#jappix_mini #chat-"+i).attr("data-type"),r=jQuery("#jappix_mini #chat-"+i+" input.jm_send-messages");if("groupchat"==n||"chat"==n&&r.attr("data-chatstates")&&!JappixCommon.exists("#jappix_mini a#friend-"+i+".jm_offline")){if(r.attr("data-chatstate")==e)return;r.attr("data-chatstate",e);var a=new JSJaCMessage;a.setTo(t),a.setType(n),a.appendNode(e,{xmlns:NS_CHATSTATES}),con.send(a),JappixConsole.log("Sent "+e+" chatstate to "+t)}}catch(o){JappixConsole.error("JappixMini.sendChatstate",o)}},e.displayChatstate=function(t,i,n,r){try{if("groupchat"==r)return;"composing"==t?jQuery("#jappix_mini #chat-"+n+" div.jm_chatstate_typing").css("visibility","visible"):e.resetChatstate(i,n,r),JappixConsole.log("Received "+t+" chatstate from "+i)}catch(a){JappixConsole.error("JappixMini.displayChatstate",a)}},e.resetChatstate=function(e,t,i){try{if("groupchat"==i)return;jQuery("#jappix_mini #chat-"+t+" div.jm_chatstate_typing").css("visibility","hidden")}catch(n){JappixConsole.error("JappixMini.resetChatstate",n)}},e.eventsChatstate=function(t,i,n){try{if("groupchat"==n)return;jQuery("#jappix_mini #chat-"+i+" input.jm_send-messages").keyup(function(n){var r=jQuery(this);13!=n.keyCode&&(r.val()&&"on"!=r.attr("data-composing")?(r.attr("data-composing","on"),e.sendChatstate("composing",t,i)):r.val()||"on"!=r.attr("data-composing")||(r.attr("data-composing","off"),e.sendChatstate("active",t,i)))}).change(function(){jQuery(this).attr("data-composing","off")}).focus(function(){var n=jQuery(this);n.is(":disabled")||(n.val()?e.sendChatstate("composing",t,i):e.sendChatstate("active",t,i))}).blur(function(){var n=jQuery(this);n.is(":disabled")||(n.val()?e.sendChatstate("paused",t,i):e.sendChatstate("inactive",t,i))})}catch(r){JappixConsole.error("JappixMini.eventsChatstate",r)}},e.soundPlay=function(){try{if("Explorer"==BrowserDetect.browser&&BrowserDetect.version<9)return!1;JappixCommon.exists("#jappix_mini #jm_audio")||jQuery("#jappix_mini").append('<div id="jm_audio"><audio preload="auto"><source src="'+JAPPIX_STATIC+'sounds/receive-message.mp3" /><source src="'+JAPPIX_STATIC+'sounds/receive-message.oga" /></audio></div>');var e=document.getElementById("jm_audio").getElementsByTagName("audio")[0];try{e.load()}finally{e.play()}}catch(t){JappixConsole.error("JappixMini.soundPlay",t)}finally{return!1}},e.adaptChat=function(e){try{var t=jQuery("#jappix_mini div.jm_conversation");if(e&&(t=t.filter(e)),t.size()){t.find("div.jm_received-messages").css({"max-height":"none","margin-top":0});var i=t.find("div.jm_pix_stream"),n=t.find("div.jm_received-messages"),r=i.height();i.find("*").size()&&r>0&&n.css({"margin-top":r,"max-height":n.height()-i.height()})}}catch(a){JappixConsole.error("JappixMini.adaptChat",a)}},e.updatePixStream=function(t){try{if(void 0!==window.localStorage){var i="#chat-"+t,n=jQuery("#jappix_mini div.jm_conversation"),r=n;t?n=n.filter(i):(n=n.filter(":has(div.jm_chat-content:visible):first"),i=n.size()?"#"+n.attr("id"):null);var a=JappixDateUtils.getTimeStamp(),o=JappixDataStore.getPersistent(MINI_HASH,"pixel-stream","start"),s=JappixDataStore.getPersistent(MINI_HASH,"pixel-stream","end"),c=!1,p=!0;if(o&&s&&!isNaN(o)&&!isNaN(s)&&(o=parseInt(o,10),s=parseInt(s,10),c=a>=o&&s>=a,p=a>=s+MINI_PIXEL_STREAM_INTERVAL),c||p)if(p&&(JappixDataStore.setPersistent(MINI_HASH,"pixel-stream","start",a),JappixDataStore.setPersistent(MINI_HASH,"pixel-stream","end",a+MINI_PIXEL_STREAM_DURATION)),i&&"on"===ADS_ENABLE&&GADS_CLIENT&&GADS_SLOT){var l=n.find("div.jm_pix_stream");if(l.find("*").size())JappixConsole.info("JappixMini.updatePixStream","Pixel stream already loaded");else{JappixConsole.info("JappixMini.updatePixStream","Loading pixel stream...");var u=r.find("div.jm_pix_stream ins.adsbygoogle:first").clone();u.size()?(JappixConsole.log("JappixMini.updatePixStream","Copy existing pixel stream from DOM"),l.html(u)):(JappixConsole.log("JappixMini.updatePixStream","Fetch fresh pixel stream from server"),l.html('<ins class="adsbygoogle"style="display:block;width:320px;height:50px;"data-ad-client="'+JappixCommon.encodeQuotes(GADS_CLIENT)+'"data-ad-slot="'+JappixCommon.encodeQuotes(GADS_SLOT)+'"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script>')),jQuery.getScript("//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js",function(){e.adaptChat(i),JappixConsole.info("JappixMini.updatePixStream","Finished loading pixel stream")})}}else e.resetPixStream();else e.resetPixStream();i&&e.adaptChat(i)}}catch(h){JappixConsole.error("JappixMini.updatePixStream",h)}},e.resetPixStream=function(){try{jQuery("#jappix_mini div.jm_pix_stream").empty()}catch(e){JappixConsole.error("JappixMini.resetPixStream",e)}},e.isLegacy=function(){try{return"Explorer"==BrowserDetect.browser&&BrowserDetect.version<=7}catch(e){JappixConsole.error("JappixMini.isLegacy",e)}},e.loadStylesheet=function(){try{var e=[],t="";JAPPIX_MINI_CSS?e.push(JAPPIX_MINI_CSS):e.push(JAPPIX_STATIC+"stylesheets/mini.css");for(var i in e)t+='<link rel="stylesheet" href="'+JappixCommon.encodeQuotes(e[i].replace(/&amp;/g,"&"))+'" type="text/css" media="all" />';return jQuery("head").append(t),!0}catch(n){return JappixConsole.error("JappixMini.loadStylesheet",n),!1}},e.configure=function(e){try{"object"!=typeof e&&(e={}),connection_config=e.connection||{},application_config=e.application||{},application_network_config=application_config.network||{},application_interface_config=application_config["interface"]||{},application_user_config=application_config.user||{},application_chat_config=application_config.chat||{},application_groupchat_config=application_config.groupchat||{},MINI_AUTOCONNECT=application_network_config.autoconnect||MINI_AUTOCONNECT,MINI_SHOWPANE=application_interface_config.showpane||MINI_SHOWPANE,MINI_ANIMATE=application_interface_config.animate||MINI_ANIMATE,MINI_RANDNICK=application_user_config.random_nickname||MINI_RANDNICK,MINI_GROUPCHAT_PRESENCE=application_groupchat_config.show_presence||MINI_GROUPCHAT_PRESENCE,MINI_DISABLE_MOBILE=application_interface_config.no_mobile||MINI_DISABLE_MOBILE,MINI_NICKNAME=application_user_config.nickname||MINI_NICKNAME,MINI_DOMAIN=connection_config.domain||MINI_DOMAIN,MINI_USER=connection_config.user||MINI_USER,MINI_PASSWORD=connection_config.password||MINI_PASSWORD,MINI_RECONNECT_MAX=application_network_config.reconnect_max||MINI_RECONNECT_MAX,MINI_RECONNECT_INTERVAL=application_network_config.reconnect_interval||MINI_RECONNECT_INTERVAL,MINI_CHATS=application_chat_config.open||MINI_CHATS,MINI_GROUPCHATS=application_groupchat_config.open||MINI_GROUPCHATS,MINI_SUGGEST_CHATS=application_chat_config.suggest||MINI_CHATS,MINI_SUGGEST_GROUPCHATS=application_groupchat_config.suggest||MINI_SUGGEST_GROUPCHATS,MINI_SUGGEST_PASSWORDS=application_groupchat_config.suggest_passwords||MINI_SUGGEST_PASSWORDS,MINI_PASSWORDS=application_groupchat_config.open_passwords||MINI_PASSWORDS,MINI_PRIORITY=connection_config.priority||MINI_PRIORITY,MINI_RESOURCE=connection_config.resource||MINI_RESOURCE,MINI_ERROR_LINK=application_interface_config.error_link||MINI_ERROR_LINK}catch(t){JappixConsole.error("JappixMini.configure",t)}},e.process=function(t,i,n,r,a,o){try{if(MINI_DISABLE_MOBILE&&JappixCommon.isMobile())return void JappixConsole.log("Jappix Mini disabled on mobile.");if(e.isLegacy())return void JappixConsole.warn("Jappix Mini cannot load on this browser (unsupported because too old)");if(MINI_DOMAIN=n,MINI_USER=r,MINI_PASSWORD=a,MINI_HASH="jm."+hex_md5(MINI_USER+"@"+MINI_DOMAIN),void 0!==o&&(MINI_PRIORITY=o),MINI_ANONYMOUS=r&&a?!1:!0,MINI_AUTOCONNECT=t&&JappixDataStore.hasDB()?!0:!1,MINI_SHOWPANE=i?!0:!1,jQuery("#jappix_mini").remove(),MINI_RECONNECT)return JappixConsole.log("Trying to reconnect (try: "+MINI_RECONNECT+")!"),e.create(n,r,a);e.loadStylesheet(),jQuery(document).keydown(function(e){return 27!=e.keyCode||JappixSystem.isDeveloper()?void 0:!1}),MINI_TITLE=document.title,jQuery(window).resize(function(){e.adaptRoster(),e.updateOverflow()}),"Opera"==BrowserDetect.browser&&(jQuery("a[href]:not([onclick])").click(function(){var t=jQuery(this),i=t.attr("href")||"",n=t.attr("target")||"";!i||i.match(/^#/i)||n.match(/_blank|_new/i)||e.saveSession()}),jQuery("form:not([onsubmit])").submit(e.saveSession)),jQuery(window).bind("beforeunload",e.saveSession),e.create(n,r,a),JappixConsole.log("Welcome to Jappix Mini! Happy coding in developer mode!")}catch(s){JappixConsole.error("JappixMini.process",s)}},e.launch=function(t){try{e.configure(t),e.process(MINI_AUTOCONNECT,MINI_SHOWPANE,MINI_DOMAIN,MINI_USER,MINI_PASSWORD,MINI_PRIORITY)}catch(i){JappixConsole.error("JappixMini.launch",i)}},e}(),launchMini=JappixMini.process;XML_LANG="en",JAPPIX_VERSION=jQuery.trim("Primo [1.1.7~dev]"),JAPPIX_STATIC="/mini/";